<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ELECTRIFY (c)</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-app: #e0e5ec; --text-main: #4a4a4a; --radius: 20px;
            --neumorph-shadow-light: #ffffff; --neumorph-shadow-dark: #a3b1c6;
            --c-yellow: #fbbf24; --c-red: #d9463b; --c-dark: #060606;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg-app); color: var(--text-main); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .app-container { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 20px; }

        .card { background: var(--bg-app); padding: 25px; border-radius: var(--radius); box-shadow: 9px 9px 16px var(--neumorph-shadow-dark), -9px -9px 16px var(--neumorph-shadow-light); border: 1px solid rgba(255,255,255,0.2); }
        h2 { margin: 0 0 20px 0; font-weight: 900; color: #333; letter-spacing: -0.5px; }

        .form-group { margin-bottom: 15px; }
        .form-label { font-size: 12px; font-weight: bold; color: #666; margin-left: 5px; display: block; margin-bottom: 5px; }
        
        .input-neumorph { width: 100%; border: none; border-radius: 12px; padding: 15px; font-family: inherit; background: var(--bg-app); box-shadow: inset 6px 6px 10px var(--neumorph-shadow-dark), inset -6px -6px 10px var(--neumorph-shadow-light); box-sizing: border-box; color: #333; outline: none; transition: 0.3s; font-weight: 500; }
        .input-neumorph:focus { box-shadow: inset 4px 4px 8px var(--neumorph-shadow-dark), inset -4px -4px 8px var(--neumorph-shadow-light); }
        textarea.input-neumorph { height: 100px; resize: none; font-family: monospace; font-weight: normal; }
        select.input-neumorph { appearance: none; background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23333%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 15px top 50%; background-size: 12px auto; cursor: pointer; }

        .btn-group { display: flex; gap: 15px; margin-top: 20px; }
        .btn-neu { flex: 1; padding: 16px; border: none; border-radius: 12px; font-weight: 700; font-size: 15px; cursor: pointer; background: var(--bg-app); box-shadow: 6px 6px 10px var(--neumorph-shadow-dark), -6px -6px 10px var(--neumorph-shadow-light); color: #333; transition: all 0.2s ease; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-neu:active { box-shadow: inset 4px 4px 8px var(--neumorph-shadow-dark), inset -4px -4px 8px var(--neumorph-shadow-light); transform: scale(0.98); }
        .btn-primary { color: #007aff; } .btn-danger { color: #ff3b30; }
        .tools-row { display: flex; gap: 10px; margin-bottom: 15px; }

                /* –ï–î–ò–¢–û–† –Ü–ù–¢–ï–†–í–ê–õ–Ü–í */
        #editorWrapper { display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(0,0,0,0.05); }
        .edit-chips-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .edit-chip { padding: 8px 12px; border-radius: 8px; font-size: 13px; font-weight: 700; cursor: pointer; background: var(--bg-app); transition: 0.2s; user-select: none; box-shadow: 3px 3px 6px var(--neumorph-shadow-dark), -3px -3px 6px var(--neumorph-shadow-light); display: flex; align-items: center; gap: 6px; }
        .edit-chip:active { transform: scale(0.95); }
        .edit-chip.off-state { border: 2px solid #888; color: #888; }
        .edit-chip.on-state { border: 2px solid var(--c-yellow); color: var(--c-yellow); }
        .edit-chip.rescued { border-color: var(--c-yellow); background: var(--c-yellow); color: #000; box-shadow: none; }
        .edit-chip.emergency { border-color: var(--c-red); background: var(--c-red); color: #fff; box-shadow: none; }

        #outputWrapper { display: none; width: 100%; margin-top: 20px;}
        #generatedImage { width: 100%; height: auto; display: block; margin-bottom: 15px; box-shadow: 5px 5px 15px rgba(0,0,0,0.15); border-radius: 0; }
        
        .copy-block { margin-top: 15px; padding: 20px; border-radius: 15px; background: var(--bg-app); cursor: pointer; transition: all 0.2s; position: relative; user-select: none; box-shadow: 7px 7px 14px var(--neumorph-shadow-dark), -7px -7px 14px var(--neumorph-shadow-light); }
        .copy-block:active { box-shadow: inset 5px 5px 10px var(--neumorph-shadow-dark), inset -5px -5px 10px var(--neumorph-shadow-light); transform: scale(0.99); }
        .copy-block.copied { background: #e3fae3; }
        .copy-content { font-family: monospace; font-size: 14px; color: #333; white-space: pre-wrap; line-height: 1.4; pointer-events: none; }
        .copy-hint { margin-top: 10px; font-size: 12px; color: #007aff; text-align: center; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

                        /* === –ë–ê–ó–û–í–ò–ô –¢–ï–ú–ù–ò–ô –®–ê–ë–õ–û–ù === */
        #captureTarget { background: var(--c-dark); color: #ffffff; padding: 25px 30px; position: absolute; left: -9999px; top: 0; width: 440px; box-sizing: border-box; -webkit-font-smoothing: antialiased; overflow: hidden; border-radius: 0; }
        
        .header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 25px; position: relative; z-index: 2; }
        .header-title { font-size: 24px; font-weight: 900; line-height: 1.25; letter-spacing: 0.5px; text-transform: uppercase; margin: 0; max-width: 320px; }
        .header-title span { color: var(--c-yellow); }
        .logo-fixed { width: 44px; height: 44px; object-fit: contain; border-radius: 50%; background: #ffffff; padding: 4px; box-sizing: border-box; flex-shrink: 0; }

        .footer-info { margin-top: 10px; padding-top: 20px; border-top: 1px solid #333; display: flex; flex-direction: column; gap: 15px; position: relative; z-index: 2; }
        .disclaimer-box { display: flex; align-items: flex-start; gap: 8px; font-size: 14px; color: #888; line-height: 1.4; font-weight: 500; }
        .disclaimer-icon { width: 16px; height: 16px; flex-shrink: 0; color: #888; margin-top: 2px; }
        .footer-source { font-size: 14px; font-weight: 500; color: #888; text-align: center; margin-top: 5px; }

        .total-time-center { text-align: center; font-family: monospace; font-size: 15px; color: #a1a1aa; margin-top: 15px; margin-bottom: 10px; position: relative; z-index: 2; font-weight: 600; }

        /* === –¢–ï–ú–ê 1: –°–ú–ê–†–¢-–î–Ü–ú (–¢–ê–ô–ú–õ–ê–ô–ù) === */
        #timelineContainer { padding-top: 5px; }
        .tl-item { display: flex; align-items: stretch; margin-bottom: 0; min-height: 65px; z-index: 2; }
        .tl-item:last-child .tl-line, .tl-item:last-child .tl-dot { display: none; } 
        .tl-item:last-child .content-col { padding-bottom: 0; }
        
        .time-col { width: 60px; text-align: right; padding-right: 15px; font-weight: 700; font-size: 18px; line-height: 24px; flex-shrink: 0; margin-top: -1px; }
        .time-col.off { color: var(--c-red); }
        .time-col.on { color: var(--c-yellow); text-shadow: 0 0 10px rgba(251, 191, 36, 0.4); }
        
        .line-col { display: flex; flex-direction: column; align-items: center; width: 28px; flex-shrink: 0; position: relative; z-index: 2; }
        .icon-circle { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: var(--c-dark); z-index: 3; }
        .icon-house { width: 16px; height: 16px; } /* –ó–±—ñ–ª—å—à–∏–≤ —Ö–∞—Ç–∏–Ω–∫—É */
        .on .icon-house { fill: var(--c-yellow); filter: drop-shadow(0 0 5px var(--c-yellow)); }
        .off .icon-house { fill: #555; }
        
        .tl-line { flex-grow: 1; width: 2px; margin: 4px 0; min-height: 35px; }
        .tl-line.dotted { background-image: linear-gradient(to bottom, #444 50%, transparent 50%); background-size: 2px 10px; }
        .tl-line.solid { background: var(--c-yellow); box-shadow: 0 0 8px var(--c-yellow); }
        .tl-dot { width: 6px; height: 6px; border-radius: 50%; z-index: 3; margin-bottom: 4px; }
        .tl-dot.dot-on { background: var(--c-yellow); box-shadow: 0 0 5px var(--c-yellow); }
        .tl-dot.dot-off { background: #555; }

        .content-col { padding-left: 15px; flex-grow: 1; padding-bottom: 25px; margin-top: -2px; }
        .info-row { display: flex; flex-direction: column; align-items: flex-start; gap: 6px; } 
        
        .badge { display: inline-flex; align-items: center; justify-content: center; padding: 2px 8px; border-radius: 6px; font-size: 12px; font-weight: 800; letter-spacing: 0.5px; height: auto; width: max-content; }
        .badge.off { background: #1a1a1c; border: 1px solid #333; color: #a1a1aa; }
        .badge.on { background: var(--c-yellow); color: #000; box-shadow: 0 0 10px rgba(251, 191, 36, 0.2); border: 1px solid var(--c-yellow); }

        .interval { display: flex; align-items: center; gap: 8px; font-size: 16px; font-weight: 600; }
        .interval-icon { width: 13px; height: 13px; display: flex; align-items: center; justify-content: center; } /* –ó–º–µ–Ω—à–∏–≤ –±–ª–∏—Å–∫–∞–≤–∫–∏ */
        .interval.off { color: var(--c-red); }
        .interval.on { color: var(--c-yellow); }

        /* === –¢–ï–ú–ê 2: –î–í–Ü –ö–û–õ–û–ù–ö–ò === */
        .tc-wrapper { display: flex; gap: 20px; text-align: center; margin-bottom: 10px; position: relative; z-index: 2; margin-top: 15px; }
        .tc-col { flex: 1; display: flex; flex-direction: column; align-items: center; }
        
        .tc-badge { padding: 8px 16px; border-radius: 12px; font-size: 14px; font-weight: 800; letter-spacing: 0.5px; margin-bottom: 20px; display: inline-block; width: 100%; box-sizing: border-box; }
        .tc-badge.off { background: var(--c-red); color: #fff; box-shadow: 0 0 15px rgba(217, 70, 59, 0.3); }
        .tc-badge.on { background: var(--c-yellow); color: #000; box-shadow: 0 0 15px rgba(251, 191, 36, 0.3); }
        
        .tc-times-wrapper { display: flex; flex-direction: column; gap: 12px; width: 100%; position: relative; padding-bottom: 20px; }
        .tc-bracket-line { position: absolute; width: 2px; background: #333; top: -10px; bottom: 0; left: 50%; transform: translateX(-50%); z-index: 1; }
        .tc-bracket-bottom { position: absolute; height: 2px; background: #333; bottom: 0; left: 20%; right: 20%; z-index: 1; }
        .tc-bracket-tick { position: absolute; width: 2px; height: 10px; background: #333; bottom: -10px; left: 50%; transform: translateX(-50%); z-index: 1; }
        
        .tc-time { font-size: 20px; font-weight: 700; letter-spacing: 1px; position: relative; z-index: 2; background: var(--c-dark); padding: 4px 0; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .tc-time.off { color: #fff; }
        .tc-time.on { color: #fff; }

        .tc-total { font-size: 14px; font-weight: 700; margin-top: 15px; color: #a1a1aa; background: var(--c-dark); padding: 0 10px; position: relative; z-index: 2; }
        .tc-lightning { position: absolute; left: 50%; top: 5px; transform: translateX(-50%); color: var(--c-yellow); width: 24px; height: 24px; }

        /* === –¢–ï–ú–ê 3: –ï–ú–û–î–ó–Ü –°–ü–õ–ï–® === */
        .emoji-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
        .emoji-content-wrapper { position: relative; z-index: 2; display: flex; flex-direction: column; align-items: center; text-align: center; padding: 10px 0 20px 0; }
        .em-time { font-size: 34px; font-weight: 800; color: var(--c-red); margin-bottom: 24px; letter-spacing: 2px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; width: 100%; }
        .em-time:last-child { margin-bottom: 0; }
        .em-arrow { width: 24px; height: 24px; color: #555; }

</style>
</head>
<body>

    <div class="app-container">
        <div class="card">
            <h2>ELECTRIFY &copy;</h2>
            
            <div class="form-group">
                <label class="form-label">–í—ñ–∑—É–∞–ª—å–Ω–∏–π –¥–∏–∑–∞–π–Ω (–º–æ–∂–Ω–∞ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –Ω–∞ –ª—å–æ—Ç—É):</label>
                <select id="designSelect" class="input-neumorph" onchange="if(globalIntervals.length) processDataAndGenerate(false)">
                    <option value="timeline">üè† –°–º–∞—Ä—Ç-–¥—ñ–º (–¢–∞–π–º–ª–∞–π–Ω)</option>
                    <option value="columns">‚öñÔ∏è –î–≤—ñ –∫–æ–ª–æ–Ω–∫–∏ (–Ñ / –ù–µ–º–∞—î)</option>
                    <option value="emojis">üéà –ú—ñ–Ω—ñ–º–∞–ª—ñ–∑–º (–†–∞–Ω–¥–æ–º–Ω—ñ –µ–º–æ–¥–∑—ñ)</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ—Å—Ç—É:</label>
                <input type="text" id="postTitleInput" class="input-neumorph" value="–ì–†–ê–§–Ü–ö –í–Ü–î–ö–õ–Æ–ß–ï–ù–¨ –ù–ê [–î–ê–¢–ê]" placeholder="–í–≤–µ–¥–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ (—Ç–µ–≥ [–î–ê–¢–ê] –∑–∞–º—ñ–Ω–∏—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ)">
            </div>

            <textarea id="rawText" class="input-neumorph" placeholder="–í—Å—Ç–∞–≤ —Ç–µ–∫—Å—Ç –≥—Ä–∞—Ñ—ñ–∫—É –≤—ñ–¥ –•–∞—Ä–∫—ñ–≤–æ–±–ª–µ–Ω–µ—Ä–≥–æ —Å—é–¥–∏ (–∑ —á–µ—Ä–≥–æ—é 1.2)..."></textarea>
            
            <div class="btn-group">
                <button class="btn-neu btn-primary" onclick="processDataAndGenerate(true)">‚ö° –°—Ç–≤–æ—Ä–∏—Ç–∏</button>
                <button class="btn-neu btn-danger" onclick="clearAll()">‚ùå</button>
            </div>

            <div id="editorWrapper">
                <label class="form-label">–°–í–Ü–¢–õ–û –ë–£–õ–û? (–Ω–∞—Ç–∏—Å–Ω–∏ –Ω–∞ –±–ª–æ–∫, —â–æ–± —Å–∫–∞—Å—É–≤–∞—Ç–∏ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è):</label>
                <div class="edit-chips-container" id="editorChips"></div>
            </div>

            <div id="debug" style="color:red; font-size:12px; margin-top:10px; text-align:center;"></div>
        </div>

        <div id="outputWrapper">
            <div class="tools-row">
                <button class="btn-neu" onclick="saveImageToGallery()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
            </div>
            <img id="generatedImage" src="">
            <div class="copy-block" id="copyBlock" onclick="copyToClipboard()">
                <div class="copy-content" id="finalText">–¢—É—Ç –±—É–¥–µ —Ç–µ–∫—Å—Ç...</div>
                <div class="copy-hint" id="copyHint">–¢–∞–ø–Ω–∏, —â–æ–± —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ —Ç–µ–∫—Å—Ç</div>
            </div>
        </div>
    </div>

    <div id="captureTarget"></div>

    <script>
        // === –Ü–ö–û–ù–ö–ò ===
        const houseSvg = `<svg class="icon-house" viewBox="0 0 24 24"><path d="M12 3L2 12h3v8h14v-8h3L12 3z"/></svg>`;
        const iconBulb = `<svg class="interval-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1.2 1.5-2.5 1.5-4a6 6 0 0 0-6-6 6 6 0 0 0-6 6c0 1.4.5 2.7 1.5 4 .7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>`;
        const iconZapOff = `<svg class="interval-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="2" y1="2" x2="22" y2="22"></line><path d="M8.5 8.5L3 14h9l-1 8 5.5-5.5"></path><path d="M16 10h5l-1.5 1.5"></path><path d="M12.4 6.6L13 2l-2.6 2.6"></path></svg>`;
        const iconInfo = `<svg class="disclaimer-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>`;
        const iconPin = `<svg class="tc-location-icon" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>`;
        const iconLightning = `<svg class="tc-lightning" viewBox="0 0 24 24" fill="currentColor"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>`;
        const iconArrow = `<svg class="em-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>`;

        // === DOM ===
        const debug = document.getElementById('debug');
        const finalTextDiv = document.getElementById('finalText');
        const copyBlock = document.getElementById('copyBlock');
        const copyHint = document.getElementById('copyHint');
        const captureTarget = document.getElementById('captureTarget');
        const outputWrapper = document.getElementById('outputWrapper');
        const generatedImage = document.getElementById('generatedImage');
        const designSelect = document.getElementById('designSelect');
        const postTitleInput = document.getElementById('postTitleInput');
        
        const editorWrapper = document.getElementById('editorWrapper');
        const editorChips = document.getElementById('editorChips');

        let lastDateStr = "";
                let lastTextIntervals = "";
        let globalIntervals = []; // –¢–µ–ø–µ—Ä –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –∞–±—Å–æ–ª—é—Ç–Ω–æ –≤—Å—ñ —ñ–Ω—Ç–µ—Ä–≤–∞–ª–∏ 24/7

        // === –•–ï–õ–ü–ï–†–ò ===
        function timeToMinutes(timeStr) {
            const [h, m] = timeStr.replace(/[^\d:]/g, '').split(':').map(Number);
            return (h || 0) * 60 + (m || 0);
        }

        function minutesToTime(mins) {
            const h = Math.floor(mins / 60);
            const m = mins % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        function getHeaderTitle(dateStr) {
            let rawTitle = postTitleInput.value.trim() || "–ì–†–ê–§–Ü–ö –í–Ü–î–ö–õ–Æ–ß–ï–ù–¨ –ù–ê [–î–ê–¢–ê]";
            return rawTitle.replace(/\[–î–ê–¢–ê\]/gi, dateStr);
        }

        function getClockEmoji(timeStr) {
            let [h, m] = timeStr.split(':').map(Number);
            if (isNaN(m)) m = 0;
            let emojiTimeH = h % 12 || 12; 
            const fullClocks = ['üïõ','üïê','üïë','üïí','üïì','üïî','üïï','üïñ','üïó','üïò','üïô','üïö'];
            const halfClocks = ['üïß','üïú','üïù','üïû','üïü','üï†','üï°','üï¢','üï£','üï§','üï•','üï¶'];
            return (m >= 30) ? halfClocks[emojiTimeH === 12 ? 0 : emojiTimeH] : fullClocks[emojiTimeH === 12 ? 0 : emojiTimeH];
        }

        // === –ì–û–õ–û–í–ù–ò–ô –ü–†–û–¶–ï–° ===
        function processDataAndGenerate(fromRawText = true) {
            debug.textContent = "";
            if (fromRawText) {
                const text = document.getElementById('rawText').value;
                const dateRegex = /(\d{1,2})\s+(—Å—ñ—á–Ω—è|–ª—é—Ç–æ–≥–æ|–±–µ—Ä–µ–∑–Ω—è|–∫–≤—ñ—Ç–Ω—è|—Ç—Ä–∞–≤–Ω—è|—á–µ—Ä–≤–Ω—è|–ª–∏–ø–Ω—è|—Å–µ—Ä–ø–Ω—è|–≤–µ—Ä–µ—Å–Ω—è|–∂–æ–≤—Ç–Ω—è|–ª–∏—Å—Ç–æ–ø–∞–¥–∞|–≥—Ä—É–¥–Ω—è)/i;
                const dateMatch = text.match(dateRegex);
                lastDateStr = dateMatch ? dateMatch[0].toUpperCase() : "–°–¨–û–ì–û–î–ù–Ü";

                const regex = /(?:^|\n)\s*1\.2\s+([^\n]+)/;
                const match = text.match(regex);
                if (!match) { debug.textContent = "–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ —á–µ—Ä–≥—É 1.2!"; return; }

                const ranges = match[1].trim().split(';');
                let tempOutages = [];

                ranges.forEach(range => {
                    let parts = range.split(/[\-\‚Äì\‚Äî]/); 
                    if (parts.length < 2) return;
                    let startStr = parts[0].trim(); 
                    let endStr = parts[1].trim();
                    let startMin = timeToMinutes(startStr);
                    let endMin = timeToMinutes(endStr);
                    
                    if (endMin === 0 || endStr === "24:00") endMin = 1440; 
                    if (endMin < startMin) endMin = 1440; 

                    tempOutages.push({ 
                        startMin, endMin, startStr, 
                        displayEndStr: (endStr === "24:00" || endMin === 1440 ? "00:00" : endStr)
                    });
                });
                tempOutages.sort((a, b) => a.startMin - b.startMin);

                globalIntervals = [];
                let currentTime = 0;

                tempOutages.forEach(outage => {
                    // –§–æ—Ä–º—É—î–º–æ –±–ª–æ–∫ "–°–≤—ñ—Ç–ª–æ —î"
                    if (currentTime < outage.startMin) {
                        globalIntervals.push({ 
                            type: 'on', isModified: false, 
                            startMin: currentTime, endMin: outage.startMin,
                            startStr: minutesToTime(currentTime), displayEndStr: minutesToTime(outage.startMin)
                        });
                    }
                    // –§–æ—Ä–º—É—î–º–æ –±–ª–æ–∫ "–í—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è"
                    globalIntervals.push({ 
                        type: 'off', isModified: false, 
                        startMin: outage.startMin, endMin: outage.endMin, 
                        displayEndStr: outage.displayEndStr, startStr: outage.startStr
                    });
                    currentTime = outage.endMin;
                });

                // –î–æ–±–∏–≤–∞—î–º–æ –¥–æ –∫—ñ–Ω—Ü—è –¥–æ–±–∏, —è–∫—â–æ —Ç—Ä–µ–±–∞
                if (currentTime < 1440) {
                    globalIntervals.push({ 
                        type: 'on', isModified: false, 
                        startMin: currentTime, endMin: 1440,
                        startStr: minutesToTime(currentTime), displayEndStr: "00:00"
                    });
                }
            }

            renderEditorChips();

            let totalOffMinutes = 0;
            let textIntervals = [];

            // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Ç–µ–∫—Å—Ç—É —ñ –≥–æ–¥–∏–Ω (–≤—Ä–∞—Ö–æ–≤—É—é—á–∏ –ê–≤–∞—Ä—ñ—ó —ñ –ü–æ—Ä—è—Ç—É–Ω–∫–∏)
            globalIntervals.forEach(int => {
                let isActuallyOff = (int.type === 'off' && !int.isModified) || (int.type === 'on' && int.isModified);
                
                if (isActuallyOff) {
                    totalOffMinutes += (int.endMin - int.startMin);
                    let note = (int.type === 'on' && int.isModified) ? " (–∞–≤–∞—Ä—ñ–π–Ω–µ ‚ö†Ô∏è)" : "";
                    textIntervals.push(`${getClockEmoji(int.startStr)} ${int.startStr}-${int.displayEndStr}${note}`);
                }
            });
            
            lastTextIntervals = textIntervals.join('\n');

            const totalHoursOff = (totalOffMinutes / 60).toFixed(1).replace('.0', '');
            const totalHoursOn = (24 - totalOffMinutes / 60).toFixed(1).replace('.0', '');

            const design = designSelect.value;
                        // –î–∏–Ω–∞–º—ñ—á–Ω–æ –¥–æ–¥–∞—î–º–æ "–í–∞–ª–∫–∏" –ø—Ä—è–º–æ –≤ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø—ñ—Å–ª—è –¥–∞—Ç–∏
            const valkyPinHtml = `<span style="display:inline-flex; align-items:center; font-size:18px; color:rgba(255,255,255,0.9); font-weight:600; text-transform:none; letter-spacing:0; margin-left:8px;">${iconPin} –í–∞–ª–∫–∏</span>`;
            const finalTitle = getHeaderTitle(lastDateStr).replace(lastDateStr, `<span>${lastDateStr}</span> ${valkyPinHtml}`);

            if (design === 'timeline') renderTimeline(globalIntervals, totalHoursOff, finalTitle);
            else if (design === 'columns') renderColumns(globalIntervals, totalHoursOff, totalHoursOn, finalTitle);
            else if (design === 'emojis') renderEmojis(globalIntervals, finalTitle);

            updateCopyText();
            outputWrapper.style.display = 'block';
            setTimeout(generateImageOutput, 300);
        }

        // –†–µ–Ω–¥–µ—Ä –∫–Ω–æ–ø–æ–∫ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è (–ß—ñ–ø–∏)
        function renderEditorChips() {
            editorChips.innerHTML = '';
            if (globalIntervals.length > 0) {
                editorWrapper.style.display = 'block';
                editorWrapper.querySelector('.form-label').innerHTML = '–†–ï–î–ê–ö–¢–û–† –ì–†–ê–§–Ü–ö–£ (–Ω–∞—Ç–∏—Å–Ω–∏ –Ω–∞ –±–ª–æ–∫, —â–æ–± –∑–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞–Ω):<br><span style="font-weight:normal; font-size:11px; color:#888; text-transform:none;">–°—ñ—Ä—ñ ‚Äî –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è (–∫–ª—ñ–∫ = —Å–≤—ñ—Ç–ª–æ –±—É–ª–æ). –ñ–æ–≤—Ç—ñ ‚Äî —Å–≤—ñ—Ç–ª–æ —î (–∫–ª—ñ–∫ = –∞–≤–∞—Ä—ñ–π–Ω–µ).</span>';

                globalIntervals.forEach((int) => {
                    const btn = document.createElement('div');
                    let timeText = `${int.startStr} - ${int.displayEndStr}`;
                    
                    if (int.type === 'off') {
                        btn.className = `edit-chip ${int.isModified ? 'rescued' : 'off-state'}`;
                        btn.innerHTML = `üåë ${timeText} ${int.isModified ? 'üí°' : ''}`;
                    } else {
                        btn.className = `edit-chip ${int.isModified ? 'emergency' : 'on-state'}`;
                        btn.innerHTML = `üí° ${timeText} ${int.isModified ? '‚ö†Ô∏è' : ''}`;
                    }

                    btn.onclick = () => {
                        int.isModified = !int.isModified;
                        processDataAndGenerate(false); 
                    };
                    editorChips.appendChild(btn);
                });
            } else {
                editorWrapper.style.display = 'none';
            }
        }

        // === –°–ü–Ü–õ–¨–ù–Ü –ï–õ–ï–ú–ï–ù–¢–ò ===
        function getStandardHeader(finalTitle) {
            return `
                <div class="header-row">
                    <div class="header-title">${finalTitle}</div>
                    <img src="./logo.png" alt="" class="logo-fixed">
                </div>`;
        }

        function getStandardFooter() {
            return `
                <div class="footer-info">
                    <div class="disclaimer-box">${iconInfo}<div>–ì—Ä–∞—Ñ—ñ–∫ —î –æ—Ä—ñ—î–Ω—Ç–æ–≤–Ω–∏–º, –æ—Å–∫—ñ–ª—å–∫–∏ —Å–∏—Ç—É–∞—Ü—ñ—è –≤ –µ–Ω–µ—Ä–≥–æ—Å–∏—Å—Ç–µ–º—ñ –ø–æ—Å—Ç—ñ–π–Ω–æ –∑–º—ñ–Ω—é—î—Ç—å—Å—è</div></div>
                    <div class="footer-source">
                        <span><b>–î–∂–µ—Ä–µ–ª–æ:</b> –•–∞—Ä–∫—ñ–≤–æ–±–ª–µ–Ω–µ—Ä–≥–æ</span>
                    </div>
                </div>`;
        }

        // === –†–ï–ù–î–ï–† –¢–ï–ú–ê 1: –°–ú–ê–†–¢ –î–Ü–ú ===
        function renderTimeline(intervals, totalHoursOff, finalTitle) {
            let html = getStandardHeader(finalTitle) + `<div id="timelineContainer">`;
                
            intervals.forEach((int, i) => {
                const isVisuallyOn = int.type === 'on';
                const stateClass = isVisuallyOn ? 'on' : 'off';
                
                // –ù–æ–≤–∞ –ª–æ–≥—ñ–∫–∞ –±–µ–π–¥–∂—ñ–≤: –ø–µ—Ä–µ–∫—Ä–µ—Å–ª–µ–Ω–Ω—è + –∞–∫—É—Ä–∞—Ç–Ω–∏–π —Ç–µ–∫—Å—Ç –ø–æ—Ä—É—á
                let badgeHtml = '';
                if (int.type === 'off') {
                    if (int.isModified) {
                        badgeHtml = `<div style="display: flex; gap: 10px; align-items: center;"><div class="badge off" style="text-decoration: line-through; text-decoration-color: var(--c-yellow); opacity: 0.6;">–í–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø</div><div style="color: var(--c-yellow); font-size: 13px; font-weight: 800; text-transform: uppercase;">üí° –°–≤—ñ—Ç–ª–æ –±—É–ª–æ</div></div>`;
                    } else {
                        badgeHtml = `<div class="badge off">–í–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø</div>`;
                    }
                } else {
                    if (int.isModified) {
                        badgeHtml = `<div style="display: flex; gap: 10px; align-items: center;"><div class="badge on" style="text-decoration: line-through; text-decoration-color: var(--c-red); opacity: 0.6;">–°–í–Ü–¢–õ–û –Ñ</div><div style="color: var(--c-red); font-size: 13px; font-weight: 800; text-transform: uppercase;">‚ö†Ô∏è –ê–≤–∞—Ä—ñ–π–Ω–µ</div></div>`;
                    } else {
                        badgeHtml = `<div class="badge on">–°–í–Ü–¢–õ–û –Ñ</div>`;
                    }
                }
                    
                const lineClass = isVisuallyOn ? 'solid' : 'dotted';
                const intIcon = isVisuallyOn ? iconBulb : iconZapOff;
                
                let dotHtml = '';
                if (i < intervals.length - 1) {
                    const nextOn = intervals[i+1].type === 'on';
                    const dotClass = nextOn ? 'dot-on' : 'dot-off';
                    dotHtml = `<div class="tl-dot ${dotClass}"></div>`;
                }

                html += `
                <div class="tl-item ${stateClass}">
                    <div class="time-col ${stateClass}">${int.startStr}</div>
                    <div class="line-col">
                        <div class="icon-circle">${houseSvg}</div>
                        <div class="tl-line ${lineClass}"></div>
                        ${dotHtml}
                    </div>
                    <div class="content-col">
                        <div class="info-row">
                            ${badgeHtml}
                            <div class="interval ${stateClass}">${intIcon} <span>${int.startStr} - ${int.displayEndStr}</span></div>
                        </div>
                    </div>
                </div>`;
            });

            html += `</div>`;
            html += `<div class="total-time-center">–ó–∞–≥–∞–ª—å–Ω–∏–π —á–∞—Å –±–µ–∑ —Å–≤—ñ—Ç–ª–∞: ~${totalHoursOff} –≥–æ–¥–∏–Ω</div>`;
            html += getStandardFooter();
            captureTarget.innerHTML = html;
        }

        // === –†–ï–ù–î–ï–† –¢–ï–ú–ê 2: –î–í–Ü –ö–û–õ–û–ù–ö–ò ===
        function renderColumns(intervals, totalHoursOff, totalHoursOn, finalTitle) {
            let offHtml = '';
            let onHtml = '';
            
            intervals.forEach(int => {
                let timeText = `${int.startStr} - ${int.displayEndStr}`;
                if (int.type === 'on') {
                    if (int.isModified) {
                        offHtml += `<div class="tc-time off" style="color: var(--c-red);"><span style="text-decoration: line-through; text-decoration-color: var(--c-red); text-decoration-thickness: 2px; opacity: 0.6;">${timeText}</span> <span style="font-size: 12px; font-weight: 800; text-transform: uppercase; margin-top: 2px;">‚ö†Ô∏è –ê–≤–∞—Ä—ñ—è</span></div>`;
                    } else {
                        onHtml += `<div class="tc-time on">${timeText}</div>`;
                    }
                } else {
                    if (int.isModified) {
                        offHtml += `<div class="tc-time off" style="color: var(--c-yellow);"><span style="text-decoration: line-through; text-decoration-color: var(--c-yellow); text-decoration-thickness: 2px; opacity: 0.6;">${timeText}</span> <span style="font-size: 12px; font-weight: 800; text-transform: uppercase; margin-top: 2px;">üí° –ë—É–ª–æ</span></div>`;
                    } else {
                        offHtml += `<div class="tc-time off">${timeText}</div>`;
                    }
                }
            });

            captureTarget.innerHTML = getStandardHeader(finalTitle) + `
                <div class="tc-wrapper">
                    ${iconLightning}
                    <div class="tc-col">
                        <div class="tc-badge off">–°–í–Ü–¢–õ–ê –ù–ï –ë–£–î–ï</div>
                        <div class="tc-times-wrapper">
                            <div class="tc-bracket-line"></div>
                            ${offHtml}
                            <div class="tc-bracket-bottom"></div>
                            <div class="tc-bracket-tick"></div>
                        </div>
                        <div class="tc-total">~${totalHoursOff} –≥–æ–¥–∏–Ω</div>
                    </div>

                    <div class="tc-col">
                        <div class="tc-badge on">–°–í–Ü–¢–õ–û –ë–£–î–ï</div>
                        <div class="tc-times-wrapper">
                            <div class="tc-bracket-line"></div>
                            ${onHtml}
                            <div class="tc-bracket-bottom"></div>
                            <div class="tc-bracket-tick"></div>
                        </div>
                        <div class="tc-total">~${totalHoursOn} –≥–æ–¥–∏–Ω</div>
                    </div>
                </div>
                ` + getStandardFooter();
        }

        // === –†–ï–ù–î–ï–† –¢–ï–ú–ê 3: –ï–ú–û–î–ó–Ü –°–ü–õ–ï–® ===
        function renderEmojis(intervals, finalTitle) {
            const emList = ['‚ö°Ô∏è', 'üí°', 'üîå', 'üî¶', 'üîã'];
            let bgHtml = '<div class="emoji-bg">';
            
            const generateSide = (baseLeft) => {
                let lastEm = '';
                for(let i=0; i<6; i++) {
                    let em;
                    do { em = emList[Math.floor(Math.random() * emList.length)]; } while (em === lastEm);
                    lastEm = em;
                    let left = baseLeft + (Math.random() * 8); 
                    let top = 8 + (i * 16) + (Math.random() * 6 - 3); 
                    let size = Math.floor(Math.random() * 14) + 20;
                    let rot = Math.floor(Math.random() * 60) - 30;
                    let opac = (Math.floor(Math.random() * 4) + 4) / 10;
                    bgHtml += `<div style="position:absolute; left:${left}%; top:${top}%; font-size:${size}px; transform:rotate(${rot}deg); opacity:${opac};">${em}</div>`;
                }
            };
            
            generateSide(2);  
            generateSide(84); 
            bgHtml += '</div>';

            let listHtml = '';
            intervals.forEach(int => {
                let timeText = `${int.startStr} ${iconArrow} ${int.displayEndStr}`;
                
                if (int.type === 'off' && !int.isModified) {
                    listHtml += `<div class="em-time">${timeText}</div>`;
                } else if (int.type === 'off' && int.isModified) {
                    listHtml += `<div class="em-time" style="color:var(--c-yellow);">
                                    <div style="display:flex; align-items:center; justify-content:center; gap:12px;">
                                        <span style="text-decoration:line-through; text-decoration-color:var(--c-yellow); text-decoration-thickness:3px; opacity:0.6;">${timeText}</span>
                                        <span style="font-size: 28px;">üí°</span>
                                    </div>
                                 </div>`;
                } else if (int.type === 'on' && int.isModified) {
                    listHtml += `<div class="em-time" style="color:var(--c-red);">
                                    <div style="display:flex; align-items:center; justify-content:center; gap:12px;">
                                        <span style="text-decoration:line-through; text-decoration-color:var(--c-red); text-decoration-thickness:3px; opacity:0.6;">${timeText}</span>
                                        <span style="font-size: 28px;">‚ö†Ô∏è</span>
                                    </div>
                                 </div>`;
                }
            });

            captureTarget.innerHTML = `
                ${bgHtml}
                <div style="position:relative; z-index:2; padding-bottom: 10px;">
                    ` + getStandardHeader(finalTitle) + `
                </div>
                <div class="emoji-content-wrapper">
                    ${listHtml}
                </div>
                ` + getStandardFooter();
        }


        // === –ü–õ–Æ–®–ö–ò ===
        function updateCopyText() {
            const header = getHeaderTitle(lastDateStr);
            finalTextDiv.textContent = `${header}\n\n${lastTextIntervals}\n\n–•–∞—Ä–∫—ñ–≤–æ–±–ª–µ–Ω–µ—Ä–≥–æ`;
            copyBlock.classList.remove('copied');
            copyHint.textContent = "–¢–∞–ø–Ω–∏, —â–æ–± —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ —Ç–µ–∫—Å—Ç";
            copyHint.style.color = "#007aff";
        }

        function generateImageOutput() {
            html2canvas(captureTarget, {
                scale: 3, backgroundColor: null, logging: false, useCORS: true
            }).then(canvas => {
                generatedImage.src = canvas.toDataURL('image/png');
            });
        }

        function copyToClipboard() {
            navigator.clipboard.writeText(finalTextDiv.textContent).then(() => {
                copyBlock.classList.add('copied');
                copyHint.textContent = "–°–ö–û–ü–Ü–ô–û–í–ê–ù–û! ‚úÖ";
                copyHint.style.color = "#28a745";
                if(navigator.vibrate) navigator.vibrate(50);
            }).catch(err => alert("–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ. –°–ø—Ä–æ–±—É–π –≤—Ä—É—á–Ω—É."));
        }

        async function saveImageToGallery() {
            if (!generatedImage.src) return;
            try {
                const response = await fetch(generatedImage.src);
                const blob = await response.blob();
                const file = new File([blob], "grafik_valky.png", { type: "image/png" });
                if (navigator.share) { await navigator.share({ files: [file] }); } 
                else { const link = document.createElement("a"); link.href = generatedImage.src; link.download = "grafik_valky.png"; document.body.appendChild(link); link.click(); document.body.removeChild(link); }
            } catch (err) { alert("–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è. –°–ø—Ä–æ–±—É–π –∑—Ä–æ–±–∏—Ç–∏ —Å–∫—Ä—ñ–Ω—à–æ—Ç."); }
        }

        function clearAll() {
            document.getElementById('rawText').value = '';
            captureTarget.innerHTML = '';
            globalIntervals = [];
            editorWrapper.style.display = 'none';
            outputWrapper.style.display = 'none';
        }
    </script>
</body>
</html>
