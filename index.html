<!DOCTYPE html>

<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ELECTRIFY ‚Ä¢ –í–ê–õ–ö–ò (c)</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-app: #e0e5ec; --text-main: #4a4a4a; --radius: 20px;
            --neumorph-shadow-light: #ffffff; --neumorph-shadow-dark: #a3b1c6;
            --c-yellow: #fbbf24; --c-red: #d9463b; --c-dark: #060606;
        }


    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg-app); color: var(--text-main); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
    .app-container { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 20px; }

    .card { background: var(--bg-app); padding: 25px; border-radius: var(--radius); box-shadow: 9px 9px 16px var(--neumorph-shadow-dark), -9px -9px 16px var(--neumorph-shadow-light); border: 1px solid rgba(255,255,255,0.2); }
    h2 { margin: 0 0 20px 0; font-weight: 900; color: #333; letter-spacing: -0.5px; }

    .form-group { margin-bottom: 15px; }
    .form-label { font-size: 12px; font-weight: bold; color: #666; margin-left: 5px; display: block; margin-bottom: 5px; }
    
    .input-neumorph { width: 100%; border: none; border-radius: 12px; padding: 15px; font-family: inherit; background: var(--bg-app); box-shadow: inset 6px 6px 10px var(--neumorph-shadow-dark), inset -6px -6px 10px var(--neumorph-shadow-light); box-sizing: border-box; color: #333; outline: none; transition: 0.3s; font-weight: 500; }
    .input-neumorph:focus { box-shadow: inset 4px 4px 8px var(--neumorph-shadow-dark), inset -4px -4px 8px var(--neumorph-shadow-light); }
    textarea.input-neumorph { height: 100px; resize: none; font-family: monospace; font-weight: normal; }
    select.input-neumorph { appearance: none; background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23333%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 15px top 50%; background-size: 12px auto; cursor: pointer; }

    .btn-group { display: flex; gap: 15px; margin-top: 20px; }
    .btn-neu { flex: 1; padding: 16px; border: none; border-radius: 12px; font-weight: 700; font-size: 15px; cursor: pointer; background: var(--bg-app); box-shadow: 6px 6px 10px var(--neumorph-shadow-dark), -6px -6px 10px var(--neumorph-shadow-light); color: #333; transition: all 0.2s ease; display: flex; justify-content: center; align-items: center; gap: 8px; }
    .btn-neu:active { box-shadow: inset 4px 4px 8px var(--neumorph-shadow-dark), inset -4px -4px 8px var(--neumorph-shadow-light); transform: scale(0.98); }
    .btn-primary { color: #007aff; } .btn-danger { color: #ff3b30; }
    .tools-row { display: flex; gap: 10px; margin-bottom: 15px; }

    /* –ï–î–ò–¢–û–† –Ü–ù–¢–ï–†–í–ê–õ–Ü–í */
    #editorWrapper { display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(0,0,0,0.05); }
    .edit-chips-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    .edit-chip { padding: 8px 12px; border-radius: 8px; font-size: 13px; font-weight: 700; cursor: pointer; background: var(--bg-app); transition: 0.2s; user-select: none; box-shadow: 3px 3px 6px var(--neumorph-shadow-dark), -3px -3px 6px var(--neumorph-shadow-light); display: flex; align-items: center; gap: 6px; }
    .edit-chip:active { transform: scale(0.95); }
    .edit-chip.off-state { border: 2px solid #888; color: #888; }
    .edit-chip.on-state { border: 2px solid var(--c-yellow); color: var(--c-yellow); }
    .edit-chip.rescued { border-color: var(--c-yellow); background: var(--c-yellow); color: #000; box-shadow: none; }
    .edit-chip.emergency { border-color: var(--c-red); background: var(--c-red); color: #fff; box-shadow: none; }

    #outputWrapper { display: none; width: 100%; margin-top: 20px;}
    #generatedImage { width: 100%; height: auto; display: block; margin-bottom: 15px; box-shadow: 5px 5px 15px rgba(0,0,0,0.15); border-radius: 0; }
    
    .copy-block { margin-top: 15px; padding: 20px; border-radius: 15px; background: var(--bg-app); cursor: pointer; transition: all 0.2s; position: relative; user-select: none; box-shadow: 7px 7px 14px var(--neumorph-shadow-dark), -7px -7px 14px var(--neumorph-shadow-light); }
    .copy-block:active { box-shadow: inset 5px 5px 10px var(--neumorph-shadow-dark), inset -5px -5px 10px var(--neumorph-shadow-light); transform: scale(0.99); }
    .copy-block.copied { background: #e3fae3; }
    .copy-content { font-family: monospace; font-size: 14px; color: #333; white-space: pre-wrap; line-height: 1.4; pointer-events: none; }
    .copy-hint { margin-top: 10px; font-size: 12px; color: #007aff; text-align: center; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

            /* === –ë–ê–ó–û–í–ò–ô –¢–ï–ú–ù–ò–ô –®–ê–ë–õ–û–ù === */
    #captureTarget { 
        background: var(--c-dark);
        color: #ffffff; 
        padding: 25px 30px; /* –ú–µ–Ω—à–µ –∑–∞–π–≤–æ–≥–æ –ø–æ–≤—ñ—Ç—Ä—è, –∞–∫—É—Ä–∞—Ç–Ω—ñ —Ä–∞–º–∫–∏ */
        position: absolute;
        left: -9999px; top: 0; 
        width: 600px; /* –Ü–¥–µ–∞–ª—å–Ω–∞ —à–∏—Ä–∏–Ω–∞ –¥–ª—è —Ç–µ–ª–µ–≥–∏, —â–æ–± –Ω–µ –±—É–ª–æ –±–ª—é—Ä-–ø–æ–ª—ñ–≤ */
        height: auto; /* –í–∏—Å–æ—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—ñ–¥–ª–∞—à—Ç–æ–≤—É—î—Ç—å—Å—è –ø—ñ–¥ –∫–æ–Ω—Ç–µ–Ω—Ç */
        min-height: auto; /* –í–±–∏–≤–∞—î–º–æ —á–µ–∫ –∑ –ê–¢–ë */
        box-sizing: border-box;
        -webkit-font-smoothing: antialiased; 
        overflow: hidden; 
        border-radius: 0; 
        display: flex; flex-direction: column; justify-content: flex-start; /* –ô–¥–µ–º–æ –∑–≤–µ—Ä—Ö—É –≤–Ω–∏–∑, –±–µ–∑ —Ü–µ–Ω—Ç—Ä—É–≤–∞–Ω–Ω—è –¥—ñ—Ä–æ–∫ */
    }


    /* === –•–ï–î–ï–† === */
    .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; position: relative; z-index: 2; padding-right: 5px; }
    .header-title { display: flex; flex-direction: column; gap: 6px; font-size: 22px; font-weight: 900; line-height: 1; letter-spacing: 0.5px; text-transform: uppercase; margin: 0; flex: 1; color: #ffffff; }
    .title-date-line { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .title-date-line span.date-text { color: var(--c-yellow); line-height: 1; }
    
    .valky-tag { display: inline-flex; align-items: center; gap: 4px; font-size: 14px; color: rgba(255,255,255,0.9); font-weight: 800; text-transform: none; letter-spacing: 0; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); padding: 4px 10px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); line-height: 1; }
    .valky-tag svg { width: 14px; height: 14px; fill: rgba(255,255,255,0.8); flex-shrink: 0; }
    
    .logo-wrapper { display: flex; align-items: center; justify-content: flex-end; flex-shrink: 0; margin-left: 15px; }
    .logo-fixed { width: 42px; height: 42px; object-fit: contain; border-radius: 50%; background: #ffffff; padding: 4px; box-sizing: border-box; flex-shrink: 0; }

    /* === –§–£–¢–ï–† –Ü –î–ñ–ï–†–ï–õ–û === */
    .footer-info { margin-top: 15px; padding-top: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px; position: relative; z-index: 2; width: 100%; }
    
    .disclaimer-box { display: flex; align-items: flex-start; justify-content: flex-start; text-align: left; gap: 10px; font-size: 12px; color: rgba(255,255,255,0.6); line-height: 1.4; font-weight: 500; width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); padding: 12px 15px; border-radius: 12px; box-sizing: border-box; }
    .disclaimer-icon { width: 14px; height: 14px; flex-shrink: 0; color: rgba(255,255,255,0.6); margin-top: 1px; }

    .source-bottom { display: inline-flex; align-items: center; justify-content: center; gap: 4px; font-size: 12px; color: rgba(255,255,255,0.7); border: 1px solid rgba(255,255,255,0.15); border-radius: 8px; padding: 6px 14px; background: rgba(0,0,0,0.3); font-weight: 600; letter-spacing: 0.5px; }
    .source-top { display: flex; align-items: center; justify-content: flex-start; gap: 4px; font-size: 11px; color: rgba(255,255,255,0.5); font-weight: 600; letter-spacing: 0.5px; margin-top: 8px; text-transform: uppercase; }

    .header-divider { height: 1px; width: 100%; background: rgba(255,255,255,0.1); margin: 15px 0; }

    /* === –¢–ï–ú–ê 1: –°–ú–ê–†–¢-–î–Ü–ú (–¢–ê–ô–ú–õ–ê–ô–ù) === */
    .total-time-center { display: flex; align-items: center; justify-content: center; gap: 6px; font-family: inherit; font-size: 13px; color: #888; margin-top: 20px; margin-bottom: 5px; position: relative; z-index: 2; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    #timelineContainer { padding-top: 0px; display: flex; flex-direction: column; gap: 0; }

    .tl-item { display: flex; flex-direction: column; z-index: 2; margin-bottom: 0; }

    .tl-head { display: flex; align-items: center; min-height: 38px; position: relative; z-index: 2; }
    
    /* === –ó–ë–Ü–õ–¨–®–ï–ù–Ü –®–†–ò–§–¢–ò –Ü –ù–û–í–Ü –ö–†–£–ñ–ï–ß–ö–ò === */
    .time-col { width: 75px; text-align: right; padding-right: 15px; font-weight: 800; font-size: 24px; flex-shrink: 0; line-height: 1; margin: 0; letter-spacing: -0.5px; } /* –ë—É–ª–æ 60px —ñ 18px */
    .interval { display: flex; align-items: center; gap: 8px; font-size: 22px; font-weight: 700; line-height: 1; } /* –ë—É–ª–æ 16px */
    .badge { display: flex; align-items: center; justify-content: center; padding: 6px 12px; border-radius: 8px; font-size: 14px; font-weight: 800; letter-spacing: 0.5px; width: max-content; line-height: 1; text-transform: uppercase; gap: 6px; } /* –ë—É–ª–æ 11px */
    .header-title { display: flex; flex-direction: column; gap: 6px; font-size: 26px; font-weight: 900; line-height: 1; letter-spacing: 0.5px; text-transform: uppercase; margin: 0; flex: 1; color: #ffffff; } /* –ë—É–ª–æ 22px */
    
    .tl-body { display: flex; align-items: stretch; min-height: 60px; position: relative; z-index: 1; } /* –¢—Ä–æ—Ö–∏ –±—ñ–ª—å—à–µ –≤–∏—Å–æ—Ç–∏, —â–æ–± –∫—Ä—É–∂–µ—á–∫–∞–º –±—É–ª–æ –¥–µ –∂–∏—Ç–∏ */
    .line-node { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; width: 36px; flex-shrink: 0; padding: 8px 0; margin: 0; }
    .tl-dot-micro { width: 8px; height: 8px; border-radius: 50%; opacity: 0.9; flex-shrink: 0;} /* –ó—Ä–æ–±–∏–ª–∏ –±—ñ–ª—å—à–∏–º–∏ –¥–ª—è –ø–æ–º—ñ—Ç–Ω–æ—Å—Ç—ñ */


    .interval-col { padding-left: 15px; flex-grow: 1; display: flex; align-items: center; }
    
    .interval { display: flex; align-items: center; gap: 8px; font-size: 16px; font-weight: 600; line-height: 1; }
    .interval-icon { display: flex; align-items: center; justify-content: center; width: 16px; height: 16px; flex-shrink: 0; }
    .interval-icon svg { width: 100%; height: 100%; display: block; }
    
    .interval-text { display: flex; align-items: center; line-height: 1; letter-spacing: 0; }
    .interval.off { color: var(--c-red); }
    .interval.on { color: var(--c-yellow); }

    .badge { display: flex; align-items: center; justify-content: center; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 800; letter-spacing: 0.5px; width: max-content; line-height: 1; text-transform: uppercase; gap: 4px; }
    .badge.off { background: #1a1a1c; border: 1px solid #333; color: #a1a1aa; }
    .badge.on { background: var(--c-yellow); color: #000; box-shadow: 0 0 10px rgba(251, 191, 36, 0.2); border: 1px solid var(--c-yellow); }
    .badge-row { display: flex; align-items: center; gap: 8px; }
    .badge-modifier { font-size: 12px; font-weight: 800; text-transform: uppercase; }
    .badge-modifier.rescued { color: var(--c-yellow); }
    .badge-modifier.emergency { color: var(--c-red); }


    /* === –¢–ï–ú–ê 2: –î–í–Ü –ö–û–õ–û–ù–ö–ò === */
    .tc-wrapper { display: flex; gap: 20px; text-align: center; margin-bottom: 10px; position: relative; z-index: 2; margin-top: 15px; }
    .tc-col { flex: 1; display: flex; flex-direction: column; align-items: center; }
    .tc-badge { padding: 8px 16px; border-radius: 12px; font-size: 14px; font-weight: 800; letter-spacing: 0.5px; margin-bottom: 20px; display: inline-block; width: 100%; box-sizing: border-box; }
    .tc-badge.off { background: var(--c-red); color: #fff; box-shadow: 0 0 15px rgba(217, 70, 59, 0.3); }
    .tc-badge.on { background: var(--c-yellow); color: #000; box-shadow: 0 0 15px rgba(251, 191, 36, 0.3); }
    .tc-times-wrapper { display: flex; flex-direction: column; gap: 12px; width: 100%; position: relative; padding-bottom: 20px; }
    .tc-bracket-line { position: absolute; width: 2px; background: #333; top: -10px; bottom: 0; left: 50%; transform: translateX(-50%); z-index: 1; }
    .tc-bracket-bottom { position: absolute; height: 2px; background: #333; bottom: 0; left: 20%; right: 20%; z-index: 1; }
    .tc-bracket-tick { position: absolute; width: 2px; height: 10px; background: #333; bottom: -10px; left: 50%; transform: translateX(-50%); z-index: 1; }
    .tc-time { font-size: 18px; font-weight: 700; letter-spacing: 1px; position: relative; z-index: 2; background: var(--c-dark); padding: 4px 0; display: flex; flex-direction: column; align-items: center; gap: 3px; }
    .tc-time.off { color: var(--c-red); }
    .tc-time.on { color: var(--c-yellow); }
    .tc-modifier { font-size: 11px; font-weight: 800; text-transform: uppercase; }
    .tc-modifier.rescued { color: var(--c-yellow); }
    .tc-modifier.emergency { color: var(--c-red); }
    .tc-total { font-size: 14px; font-weight: 700; margin-top: 15px; color: #888; background: var(--c-dark); padding: 0 10px; position: relative; z-index: 2; }
    .tc-lightning { position: absolute; left: 50%; top: 5px; transform: translateX(-50%); color: var(--c-yellow); width: 24px; height: 24px; }

    /* === –¢–ï–ú–ê 3: –ï–ú–û–î–ó–Ü –°–ü–õ–ï–® === */
    .emoji-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
    .emoji-content-wrapper { position: relative; z-index: 2; display: flex; flex-direction: column; align-items: center; text-align: center; padding: 5px 0 15px 0; }
    .em-rows { width: 100%; display: flex; flex-direction: column; gap: 10px; }
    .em-row { display: flex; justify-content: center; gap: 20px; }
    .em-time { font-size: 20px; font-weight: 800; color: var(--c-red); display: flex; align-items: center; justify-content: center; gap: 5px; }
    .em-time .em-arrow { width: 16px; height: 16px; color: var(--c-red); }
    .em-time.is-off { color: var(--c-red); }
    .em-time.is-rescued { color: var(--c-yellow); opacity: 0.7; }
    .em-time.is-rescued .em-time-text { text-decoration: line-through; text-decoration-color: var(--c-yellow); text-decoration-thickness: 2px; }
    .em-time.is-emergency { color: var(--c-red); opacity: 0.7; }
    .em-time.is-emergency .em-time-text { text-decoration: line-through; text-decoration-color: var(--c-red); text-decoration-thickness: 2px; }

</style>


</head>
<body>

<div class="app-container">
    <div class="card">
        <h2>ELECTRIFY ‚Ä¢ –í–∞–ª–∫–∏ &copy;</h2>


    <div class="form-group">
        <label class="form-label">–í—ñ–∑—É–∞–ª—å–Ω–∏–π –¥–∏–∑–∞–π–Ω:</label>
        <select id="designSelect" class="input-neumorph" onchange="if(globalIntervals.length) processDataAndGenerate(false)">
            <option value="timeline">üè† –°–º–∞—Ä—Ç-–¥—ñ–º (–¢–∞–π–º–ª–∞–π–Ω)</option>
            <option value="columns">‚öñÔ∏è –î–≤—ñ –∫–æ–ª–æ–Ω–∫–∏ (–Ñ / –ù–µ–º–∞—î)</option>
            <option value="emojis">üéà –ú—ñ–Ω—ñ–º–∞–ª—ñ–∑–º (–†–∞–Ω–¥–æ–º–Ω—ñ –µ–º–æ–¥–∑—ñ)</option>
        </select>
    </div>

    <div class="form-group">
        <label class="form-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ—Å—Ç—É:</label>
        <input type="text" id="postTitleInput" class="input-neumorph" value="–ì–†–ê–§–Ü–ö –í–Ü–î–ö–õ–Æ–ß–ï–ù–¨ [–î–ê–¢–ê]" placeholder="–í–≤–µ–¥–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ (—Ç–µ–≥ [–î–ê–¢–ê] –∑–∞–º—ñ–Ω–∏—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ)">
    </div>

    <textarea id="rawText" class="input-neumorph" placeholder="–í—Å—Ç–∞–≤ —Ç–µ–∫—Å—Ç –≥—Ä–∞—Ñ—ñ–∫—É –≤—ñ–¥ –•–∞—Ä–∫—ñ–≤–æ–±–ª–µ–Ω–µ—Ä–≥–æ —Å—é–¥–∏ (–∑ —á–µ—Ä–≥–æ—é 1.2)..."></textarea>
    
    <div class="btn-group">
        <button class="btn-neu btn-primary" onclick="processDataAndGenerate(true)">‚ö° –°—Ç–≤–æ—Ä–∏—Ç–∏</button>
        <button class="btn-neu btn-danger" onclick="clearAll()">‚ùå</button>
    </div>

    <div id="editorWrapper">
        <label class="form-label">–†–ï–î–ê–ö–¢–û–† –ì–†–ê–§–Ü–ö–£ (–Ω–∞—Ç–∏—Å–Ω–∏ –Ω–∞ –±–ª–æ–∫, —â–æ–± –∑–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞–Ω):<br><span style="font-weight:normal; font-size:11px; color:#888; text-transform:none;">–°—ñ—Ä—ñ ‚Äî –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è (–∫–ª—ñ–∫ = —Å–≤—ñ—Ç–ª–æ –±—É–ª–æ). –ñ–æ–≤—Ç—ñ ‚Äî —Å–≤—ñ—Ç–ª–æ —î (–∫–ª—ñ–∫ = –∞–≤–∞—Ä—ñ–π–Ω–µ).</span></label>
        <div class="edit-chips-container" id="editorChips"></div>
    </div>

    <div id="debug" style="color:red; font-size:12px; margin-top:10px; text-align:center;"></div>
</div>

<div id="outputWrapper">
    <div class="tools-row">
        <button class="btn-neu" onclick="saveImageToGallery()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
    </div>
    <img id="generatedImage" src="">
    <div class="copy-block" id="copyBlock" onclick="copyToClipboard()">
        <div class="copy-content" id="finalText">–¢—É—Ç –±—É–¥–µ —Ç–µ–∫—Å—Ç...</div>
        <div class="copy-hint" id="copyHint">–¢–∞–ø–Ω–∏, —â–æ–± —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ —Ç–µ–∫—Å—Ç</div>
    </div>
</div>


</div>

<div id="captureTarget"></div>

<script>
    // === –Ü–ö–û–ù–ö–ò ===
    const houseSvg = `<svg class="icon-house" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>`;
    const iconSource = `<svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>`;
    const iconClock = `üïò`;
    const iconSparkles = `<svg viewBox="0 0 512 512" width="12" height="12" fill="currentColor" style="margin-right:4px; margin-bottom:1px;"><path d="M327.5 104.2l-14-42.6c-2.5-7.6-13.4-7.6-15.9 0l-14 42.6c-4.4 13.5-15 24.1-28.5 28.5l-42.6 14c-7.6 2.5-7.6 13.4 0 15.9l42.6 14c13.5 4.4 24.1 15 28.5 28.5l14 42.6c2.5 7.6 13.4 7.6 15.9 0l14-42.6c4.4-13.5 15-24.1 28.5-28.5l42.6-14c7.6-2.5 7.6-13.4 0-15.9l-42.6-14c-13.5-4.4-24.1-15-28.5-28.5zM433.8 335.5l-9.1-27.6c-1.6-4.9-8.7-4.9-10.3 0l-9.1 27.6c-2.9 8.7-9.8 15.7-18.5 18.5l-27.6 9.1c-4.9 1.6-4.9 8.7 0 10.3l27.6 9.1c8.7 2.9 15.7 9.8 18.5 18.5l9.1 27.6c1.6 4.9 8.7 4.9 10.3 0l9.1-27.6c2.9-8.7 9.8-15.7 18.5-18.5l27.6-9.1c4.9-1.6 4.9-8.7 0-10.3l-27.6-9.1c-8.7-2.9-15.7-9.8-18.5-18.5zM152 352l-20.4-61.9c-3.6-11-19.5-11-23.1 0L88 352c-6.4 19.5-21.6 34.8-41.2 41.2l-61.9 20.4c-11 3.6-11 19.5 0 23.1l61.9 20.4c19.5 6.4 34.8 21.6 41.2 41.2l20.4 61.9c3.6 11 19.5 11 23.1 0l20.4-61.9c6.4-19.5 21.6-34.8 41.2-41.2l61.9-20.4c11-3.6 11-19.5 0-23.1l-61.9-20.4c-19.5-6.4-34.8-21.6-41.2-41.2z"/></svg>`;
    const iconBan = `<svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="margin-right:4px; margin-bottom:1px;"><circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line></svg>`;
    const iconLightningSVG = `<svg viewBox="0 0 24 24" width="12" height="12" fill="currentColor" stroke="none" style="margin-right:4px; display:inline-block; vertical-align:middle;"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>`;
    const iconClockSVG = `<svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`;
    const iconLink = `<svg viewBox="0 0 24 24" width="10" height="10" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="display:block; margin-right:4px;"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>`;
    const iconBulb = `<svg class="interval-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1.2 1.5-2.5 1.5-4a6 6 0 0 0-6-6 6 6 0 0 0-6 6c0 1.4.5 2.7 1.5 4 .7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>`;
    const iconZapOff = `<svg class="interval-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="2" y1="2" x2="22" y2="22"></line><path d="M8.5 8.5L3 14h9l-1 8 5.5-5.5"></path><path d="M16 10h5l-1.5 1.5"></path><path d="M12.4 6.6L13 2l-2.6 2.6"></path></svg>`;
    const iconInfo = `<svg class="disclaimer-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="overflow:visible; min-width:14px;"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><circle cx="12" cy="8" r="1" fill="currentColor" stroke="none"/></svg>`;
    const iconPin = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>`;
    const iconLightning = `<svg class="tc-lightning" viewBox="0 0 24 24" fill="currentColor"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>`;
    const iconArrow = `<svg class="em-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>`;

    // === DOM ===
    const debug = document.getElementById('debug');
    const finalTextDiv = document.getElementById('finalText');
    const copyBlock = document.getElementById('copyBlock');
    const copyHint = document.getElementById('copyHint');
    const captureTarget = document.getElementById('captureTarget');
    const outputWrapper = document.getElementById('outputWrapper');
    const generatedImage = document.getElementById('generatedImage');
    const designSelect = document.getElementById('designSelect');
    const postTitleInput = document.getElementById('postTitleInput');
    
    const editorWrapper = document.getElementById('editorWrapper');
    const editorChips = document.getElementById('editorChips');

    let lastDateStr = "";
    let lastTextIntervals = "";
    let globalIntervals = [];

    // === –•–ï–õ–ü–ï–†–ò ===
    function timeToMinutes(timeStr) {
        const [h, m] = timeStr.replace(/[^\d:]/g, '').split(':').map(Number);
        return (h || 0) * 60 + (m || 0);
    }

    function minutesToTime(mins) {
        const h = Math.floor(mins / 60);
        const m = mins % 60;
        return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
    }

    function getHeaderTitle(dateStr) {
        let rawTitle = postTitleInput.value.trim() || "–ì–†–ê–§–Ü–ö –í–Ü–î–ö–õ–Æ–ß–ï–ù–¨ [–î–ê–¢–ê]";
        return rawTitle.replace(/\[–î–ê–¢–ê\]/gi, dateStr);
    }

    function getClockEmoji(timeStr) {
        let [h, m] = timeStr.split(':').map(Number);
        if (isNaN(m)) m = 0;
        let emojiTimeH = h % 12 || 12; 
        const fullClocks = ['üïõ','üïê','üïë','üïí','üïì','üïî','üïï','üïñ','üïó','üïò','üïô','üïö'];
        const halfClocks = ['üïß','üïú','üïù','üïû','üïü','üï†','üï°','üï¢','üï£','üï§','üï•','üï¶'];
        return (m >= 30) ? halfClocks[emojiTimeH === 12 ? 0 : emojiTimeH] : fullClocks[emojiTimeH === 12 ? 0 : emojiTimeH];
    }

    // === –°–ü–Ü–õ–¨–ù–ò–ô –•–ï–î–ï–† ===
    function getStandardHeader(dateStr, rawTitleTemplate) {
        let rawTitle = rawTitleTemplate || postTitleInput.value.trim() || "–ì–†–ê–§–Ü–ö –í–Ü–î–ö–õ–Æ–ß–ï–ù–¨ [–î–ê–¢–ê]";
        const dateTagIndex = rawTitle.toUpperCase().indexOf('[–î–ê–¢–ê]');
        let beforeDate = dateTagIndex >= 0 ? rawTitle.substring(0, dateTagIndex) : rawTitle;
        let hasDate = dateTagIndex >= 0;

        const valkyHtml = `<div class="valky-tag">${iconPin} –í–∞–ª–∫–∏</div>`;
        let titleHtml = hasDate 
            ? `<div>${beforeDate.trim()}</div>
               <div class="title-date-line">
                   <span class="date-text">${dateStr}</span>
                   ${valkyHtml}
               </div>` 
            : `<div>${rawTitle}</div>${valkyHtml}`;
        return `
            <div class="header-row">
                <div class="header-title">${titleHtml}</div>
                <div class="logo-wrapper"><img src="./logo.png" alt="" class="logo-fixed"></div>
            </div>`;
    }

    // === –°–ü–Ü–õ–¨–ù–ò–ô –§–£–¢–ï–† ===
    function getStandardFooter(showSourceAtBottom = true) {
        let sourceHtml = showSourceAtBottom ? `<div class="source-bottom">${iconLink} –î–∂–µ—Ä–µ–ª–æ: –•–∞—Ä–∫—ñ–≤–æ–±–ª–µ–Ω–µ—Ä–≥–æ</div>` : '';
        return `
            <div class="footer-info">
                <div class="disclaimer-box">
                    ${iconInfo}
                    <span>–§–∞–∫—Ç–∏—á–Ω–∏–π —á–∞—Å —ñ —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å –≤—ñ–¥–∫–ª—é—á–µ–Ω—å –º–æ–∂—É—Ç—å –∑–º—ñ–Ω—é–≤–∞—Ç–∏—Å—è –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Å—Ç–∞–Ω—É –µ–Ω–µ—Ä–≥–æ—Å–∏—Å—Ç–µ–º–∏ / –∞–≤–∞—Ä—ñ–π–Ω–∏—Ö —Å–∏—Ç—É–∞—Ü—ñ–π</span>
                </div>
                ${sourceHtml}
            </div>`;
    }

    // === –ì–û–õ–û–í–ù–ò–ô –ü–†–û–¶–ï–° ===
    function processDataAndGenerate(fromRawText = true) {
        debug.textContent = "";
        if (fromRawText) {
            const text = document.getElementById('rawText').value;
            const dateRegex = /(\d{1,2})\s+(—Å—ñ—á–Ω—è|–ª—é—Ç–æ–≥–æ|–±–µ—Ä–µ–∑–Ω—è|–∫–≤—ñ—Ç–Ω—è|—Ç—Ä–∞–≤–Ω—è|—á–µ—Ä–≤–Ω—è|–ª–∏–ø–Ω—è|—Å–µ—Ä–ø–Ω—è|–≤–µ—Ä–µ—Å–Ω—è|–∂–æ–≤—Ç–Ω—è|–ª–∏—Å—Ç–æ–ø–∞–¥–∞|–≥—Ä—É–¥–Ω—è)/i;
            const dateMatch = text.match(dateRegex);
            lastDateStr = dateMatch ? dateMatch[0].toUpperCase() : "–°–¨–û–ì–û–î–ù–Ü";

            const regex = /(?:^|\n)\s*1\.2\s+([^\n]+)/;
            const match = text.match(regex);
            if (!match) { debug.textContent = "–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ —á–µ—Ä–≥—É 1.2!"; return; }

            const ranges = match[1].trim().split(';');
            let tempOutages = [];
            ranges.forEach(range => {
                let parts = range.split(/[\-\‚Äì\‚Äî]/); 
                if (parts.length < 2) return;
                let startStr = parts[0].trim(); 
                let endStr = parts[1].trim();
                let startMin = timeToMinutes(startStr);
                let endMin = timeToMinutes(endStr);
                
                if (endMin === 0 || endStr === "24:00") endMin = 1440; 
                if (endMin < startMin) endMin = 1440; 

                tempOutages.push({ 
                    startMin, endMin, startStr, 
                    displayEndStr: (endStr === "24:00" || endMin === 1440 ? "00:00" : endStr)
                });
            });
            tempOutages.sort((a, b) => a.startMin - b.startMin);

            globalIntervals = [];
            let currentTime = 0;
            tempOutages.forEach(outage => {
                if (currentTime < outage.startMin) {
                    globalIntervals.push({ 
                        type: 'on', isModified: false, 
                        startMin: currentTime, endMin: outage.startMin,
                        startStr: minutesToTime(currentTime), displayEndStr: minutesToTime(outage.startMin)
                    });
                }
                globalIntervals.push({ 
                    type: 'off', isModified: false, 
                    startMin: outage.startMin, endMin: outage.endMin, 
                    displayEndStr: outage.displayEndStr, startStr: outage.startStr
                });
                currentTime = outage.endMin;
            });
            if (currentTime < 1440) {
                globalIntervals.push({ 
                    type: 'on', isModified: false, 
                    startMin: currentTime, endMin: 1440,
                    startStr: minutesToTime(currentTime), displayEndStr: "00:00"
                });
            }
        }

        renderEditorChips();
        let totalOffMinutes = 0;
        let textIntervals = [];

        globalIntervals.forEach(int => {
            let isActuallyOff = (int.type === 'off' && !int.isModified) || (int.type === 'on' && int.isModified);
            
            if (isActuallyOff) {
                totalOffMinutes += (int.endMin - int.startMin);
                let note = (int.type === 'on' && int.isModified) ? " (–∞–≤–∞—Ä—ñ–π–Ω–µ ‚ö†Ô∏è)" : "";
                textIntervals.push(`${getClockEmoji(int.startStr)} ${int.startStr}-${int.displayEndStr}${note}`);
            }
        });
        lastTextIntervals = textIntervals.join('\n');

        const totalHoursOff = (totalOffMinutes / 60).toFixed(1).replace('.0', '');
        const totalHoursOn = (24 - totalOffMinutes / 60).toFixed(1).replace('.0', '');
        const design = designSelect.value;

        if (design === 'timeline') renderTimeline(globalIntervals, totalHoursOff);
        else if (design === 'columns') renderColumns(globalIntervals, totalHoursOff, totalHoursOn);
        else if (design === 'emojis') renderEmojis(globalIntervals);

        updateCopyText();
        outputWrapper.style.display = 'block';
        setTimeout(generateImageOutput, 300);
    }
    
    // –†–µ–Ω–¥–µ—Ä –∫–Ω–æ–ø–æ–∫ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
    function renderEditorChips() {
        editorChips.innerHTML = '';
        if (globalIntervals.length > 0) {
            editorWrapper.style.display = 'block';
            globalIntervals.forEach((int) => {
                const btn = document.createElement('div');
                let timeText = `${int.startStr} - ${int.displayEndStr}`;
                
                if (int.type === 'off') {
                    btn.className = `edit-chip ${int.isModified ? 'rescued' : 'off-state'}`;
                    btn.innerHTML = `üåë ${timeText} ${int.isModified ? 'üí°' : ''}`;
                } else {
                    btn.className = `edit-chip ${int.isModified ? 'emergency' : 'on-state'}`;
                    btn.innerHTML = `üí° ${timeText} ${int.isModified ? '‚ö†Ô∏è' : ''}`;
                }

                btn.onclick = () => {
                    int.isModified = !int.isModified;
                    processDataAndGenerate(false); 
                };
                editorChips.appendChild(btn);
            });
        } else {
            editorWrapper.style.display = 'none';
        }
    }

        // === –†–ï–ù–î–ï–† –¢–ï–ú–ê 1: –°–ú–ê–†–¢ –î–Ü–ú ===
        // === –†–ï–ù–î–ï–† –¢–ï–ú–ê 1: –°–ú–ê–†–¢ –î–Ü–ú ===
    function renderTimeline(intervals, totalHoursOff) {
        let headerContent = getStandardHeader(lastDateStr);
        headerContent += `<div class="source-top">${iconLink} –î–∂–µ—Ä–µ–ª–æ: –•–∞—Ä–∫—ñ–≤–æ–±–ª–µ–Ω–µ—Ä–≥–æ</div>`;
        headerContent += `<div class="header-divider"></div>`;

        // –í–æ—Ç–µ—Ä–º–∞—Ä–∫–∞ –Ω–∞ —Ñ–æ–Ω (–∑ —Ç–≤–æ–≥–æ —Ñ–∞–π–ª—É logo.png)
        let bgWatermark = `<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; display: flex; align-items: center; justify-content: center; opacity: 0.04; pointer-events: none;">
            <img src="./logo.png" style="width: 90%; max-width: 400px; object-fit: contain; filter: grayscale(100%);">
        </div>`;

        // –û–±–µ—Ä—Ç–∞—î–º–æ –≤–µ—Å—å –∫–æ–Ω—Ç–µ–Ω—Ç —É relative –±–ª–æ–∫, —â–æ–± –≤—ñ–Ω –±—É–≤ –Ω–∞–¥ –≤–æ—Ç–µ—Ä–º–∞—Ä–∫–æ—é
        let html = bgWatermark + `<div style="position: relative; z-index: 2;">` + headerContent + `<div id="timelineContainer">`;
        
        intervals.forEach((int, i) => {
            const isVisuallyOn = int.type === 'on';
            const stateClass = isVisuallyOn ? 'on' : 'off';
            const redBanIcon = `<span style="color: var(--c-red); display: flex; align-items: center;">${iconBan}</span>`;
            
            let badgeHtml = '';
            let intervalTextStyle = '';

            if (int.type === 'off') {
                if (int.isModified) {
                    badgeHtml = `<div class="badge-row"><div class="badge off" style="text-decoration: line-through; opacity: 0.55;">${redBanIcon} –í–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø</div><span class="badge-modifier rescued">üí° –°–≤—ñ—Ç–ª–æ –±—É–ª–æ</span></div>`;
                    intervalTextStyle = `color: rgba(251, 191, 36, 0.7); text-decoration: line-through; text-decoration-color: rgba(251, 191, 36, 0.7); text-decoration-thickness: 2px;`;
                } else {
                    badgeHtml = `<div class="badge off">${redBanIcon} –í–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø</div>`;
                }
            } else {
                if (int.isModified) {
                    badgeHtml = `<div class="badge-row"><div class="badge on" style="text-decoration: line-through; opacity: 0.55; color: #000;">${iconLightningSVG} –°–í–Ü–¢–õ–û –Ñ</div><span class="badge-modifier emergency">‚ö†Ô∏è –ê–≤–∞—Ä—ñ–π–Ω–µ</span></div>`;
                    intervalTextStyle = `color: #888; text-decoration: line-through; text-decoration-color: #888; text-decoration-thickness: 2px;`;
                } else {
                    badgeHtml = `<div class="badge on" style="color: #000;">${iconLightningSVG} –°–í–Ü–¢–õ–û –Ñ</div>`;
                }
            }
                
            const intIcon = isVisuallyOn ? iconBulb : iconZapOff;
            
            /* === –†–û–ó–£–ú–ù–Ü –ö–†–£–ñ–ï–ß–ö–ò (1 –≥–æ–¥ = 1 –∫—Ä—É–∂–µ—á–æ–∫) === */
            let durationMins = int.endMin - int.startMin;
            if (durationMins < 0) durationMins += 1440; 
            let hours = durationMins / 60;
            let fullDots = Math.floor(hours);
            let hasHalfDot = (hours - fullDots) >= 0.4; // –Ø–∫—â–æ –∑–∞–ª–∏—à–æ–∫ –±—ñ–ª—å—à–µ 24 —Ö–≤–∏–ª–∏–Ω ‚Äî –º–∞–ª—é—î–º–æ –ø–æ–ª–æ–≤–∏–Ω–∫—É

            let dotsHtml = '';
            if (i < intervals.length - 1) { 
                // –ú–∞–ª—é—î–º–æ —Ü—ñ–ª—ñ –≥–æ–¥–∏–Ω–∏
                for(let d = 0; d < fullDots; d++) {
                    dotsHtml += `<div class="tl-dot-micro ${stateClass}"></div>`;
                }
                // –ú–∞–ª—é—î–º–æ –ø–æ–ª–æ–≤–∏–Ω–∫—É, —è–∫—â–æ —Ç—Ä–µ–±–∞
                if(hasHalfDot) {
                    let halfColor = isVisuallyOn ? "var(--c-yellow)" : "#555";
                    let shadow = isVisuallyOn ? "box-shadow: 0 0 4px rgba(251, 191, 36, 0.5);" : "";
                    dotsHtml += `<div class="tl-dot-micro" style="background: linear-gradient(to bottom, ${halfColor} 50%, transparent 50%); border: 1px solid ${halfColor}; box-sizing: border-box; ${shadow}"></div>`;
                }
                // –Ø–∫—â–æ —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å –Ω–∞—Å—Ç—ñ–ª—å–∫–∏ –º—ñ–∑–µ—Ä–Ω–∞, —â–æ –≤–∏–π—à–æ–≤ 0 (—Ö–æ—á–∞ —Ç–∞–∫–æ–≥–æ –Ω–µ –±—É–≤–∞—î –≤ –≥—Ä–∞—Ñ—ñ–∫–∞—Ö, –∞–ª–µ –¥–ª—è —Å–µ–π—Ñ—Ç—ñ)
                if(fullDots === 0 && !hasHalfDot) {
                    dotsHtml += `<div class="tl-dot-micro ${stateClass}" style="transform: scale(0.6);"></div>`;
                }
            } else {
                // –û—Å—Ç–∞–Ω–Ω—ñ–π —ñ–Ω—Ç–µ—Ä–≤–∞–ª –¥–æ–±–∏: –ø—Ä–æ—Å—Ç–æ –∑–∞—Ç—É—Ö–∞–Ω–Ω—è
                dotsHtml += `<div class="tl-dot-micro ${stateClass}" style="width: 5px; height: 5px; opacity: 0.6"></div>`;
                dotsHtml += `<div class="tl-dot-micro ${stateClass}" style="width: 3px; height: 3px; opacity: 0.3"></div>`;
            }

            let endTextAddon = (int.endMin === 1440 || int.displayEndStr === "24:00") 
                ? ` <span style="font-size: 13px; opacity: 0.6; font-weight: 500; margin-left: 6px; text-transform: lowercase;">(–¥–æ –∫—ñ–Ω—Ü—è –¥–æ–±–∏)</span>` 
                : ``;

            html += `
            <div class="tl-item ${stateClass}">
                <div class="tl-head">
                    <div class="time-col ${stateClass}">${int.startStr}</div>
                    <div class="icon-node">
                        <div class="icon-circle">${houseSvg}</div>
                    </div>
                    <div class="badge-col">${badgeHtml}</div>
                </div>
                <div class="tl-body">
                    <div class="time-col"></div>
                    <div class="line-node">
                        ${dotsHtml}
                    </div>
                    <div class="interval-col">
                        <div class="interval ${stateClass}">
                            <div class="interval-icon">${intIcon}</div>
                            <span class="interval-text" style="${intervalTextStyle}">${int.startStr} - ${int.displayEndStr}${endTextAddon}</span>
                        </div>
                    </div>
                </div>
            </div>`;
        });

        html += `</div></div>`; // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ timelineContainer —ñ relative –±–ª–æ–∫ –≤–æ—Ç–µ—Ä–º–∞—Ä–∫–∏
        
        // –í–∏–≤–µ–ª–∏ —Ñ—É—Ç–µ—Ä –±–µ–∑ –∑–∞–≥–∞–ª—å–Ω–æ–≥–æ —á–∞—Å—É
        html += getStandardFooter(false); 
        captureTarget.innerHTML = html;
    }





    // === –†–ï–ù–î–ï–† –¢–ï–ú–ê 2: –î–í–Ü –ö–û–õ–û–ù–ö–ò ===
        // === –†–ï–ù–î–ï–† –¢–ï–ú–ê 2: –î–í–Ü –ö–û–õ–û–ù–ö–ò ===
    function renderColumns(intervals, totalHoursOff, totalHoursOn) {
        let offHtml = '';
        let onHtml = '';
        
        intervals.forEach(int => {
            let timeText = `${int.startStr} - ${int.displayEndStr}`;
            if (int.type === 'on') {
                if (int.isModified) offHtml += `<div class="tc-time off"><span style="text-decoration: line-through; opacity: 0.6;">${timeText}</span><span class="tc-modifier emergency">‚ö†Ô∏è –ê–≤–∞—Ä—ñ—è</span></div>`;
                else onHtml += `<div class="tc-time on">${timeText}</div>`;
            } else {
                if (int.isModified) offHtml += `<div class="tc-time off"><span style="text-decoration: line-through; opacity: 0.6;">${timeText}</span><span class="tc-modifier rescued">üí° –ë—É–ª–æ</span></div>`;
                else offHtml += `<div class="tc-time off">${timeText}</div>`;
            }
        });

        // –°—Ç–≤–æ—Ä—é—î–º–æ —Ö–∞—Ç–∏–Ω–∫–∏
        const houseOff = `<div class="icon-node" style="margin: 0 auto 15px;"><div class="icon-circle" style="background: #1a1a1c;"><svg class="icon-house" viewBox="0 0 24 24" fill="#555"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></div></div>`;
        const houseOn = `<div class="icon-node" style="margin: 0 auto 15px;"><div class="icon-circle"><svg class="icon-house" viewBox="0 0 24 24" fill="var(--c-yellow)" style="filter: drop-shadow(0 0 5px var(--c-yellow));"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></div></div>`;

        captureTarget.innerHTML = getStandardHeader(lastDateStr) + `
            <div class="tc-wrapper">
                <div class="tc-col">
                    ${houseOff}
                    <div class="tc-badge off"><span style="color: var(--c-red); display: inline-block; margin-right: 4px;">${iconBan}</span> –°–í–Ü–¢–õ–ê –ù–ï –ë–£–î–ï</div>
                    <div class="tc-times-wrapper"><div class="tc-bracket-line"></div>${offHtml}<div class="tc-bracket-bottom"></div><div class="tc-bracket-tick"></div></div>
                    <div class="tc-total">${iconClockSVG} ~${totalHoursOff} –≥–æ–¥</div>
                </div>
                <div class="tc-col">
                    ${houseOn}
                    <div class="tc-badge on" style="color: #000;">${iconLightningSVG} –°–í–Ü–¢–õ–û –ë–£–î–ï</div>
                    <div class="tc-times-wrapper"><div class="tc-bracket-line"></div>${onHtml}<div class="tc-bracket-bottom"></div><div class="tc-bracket-tick"></div></div>
                    <div class="tc-total">${iconClockSVG} ~${totalHoursOn} –≥–æ–¥</div>
                </div>
            </div>` + getStandardFooter();
    }


    // === –†–ï–ù–î–ï–† –¢–ï–ú–ê 3: –ï–ú–û–î–ó–Ü –ú–Ü–ù–Ü–ú–ê–õ–Ü–ó–ú ===
    function renderEmojis(intervals) {
        const emList = ['‚ö°Ô∏è', 'üí°', 'üîå', 'üî¶', 'üîã'];
        let bgHtml = '<div class="emoji-bg">';
        const generateSide = (baseLeft) => {
            let lastEm = '';
            for(let i=0; i<6; i++) {
                let em; do { em = emList[Math.floor(Math.random() * emList.length)]; } while (em === lastEm); lastEm = em;
                let left = baseLeft + (Math.random() * 8); let top = 8 + (i * 16) + (Math.random() * 6 - 3);
                let size = Math.floor(Math.random() * 14) + 20; let rot = Math.floor(Math.random() * 60) - 30;
                let opac = (Math.floor(Math.random() * 4) + 4) / 10;
                bgHtml += `<div style="position:absolute; left:${left}%; top:${top}%; font-size:${size}px; transform:rotate(${rot}deg); opacity:${opac};">${em}</div>`;
            }
        };
        generateSide(2); generateSide(84); bgHtml += '</div>';

        let offIntervals = intervals.filter(int => (int.type === 'off' && !int.isModified) || (int.type === 'on' && int.isModified));
        let rowsHtml = '';
        offIntervals.forEach(int => {
            let timeText = `${int.startStr}${iconArrow}${int.displayEndStr}`;
            if (int.type === 'on' && int.isModified) rowsHtml += `<div class="em-row"><div class="em-time is-emergency"><span class="em-time-text">${timeText}</span> ‚ö†Ô∏è</div></div>`;
            else if (int.type === 'off' && int.isModified) rowsHtml += `<div class="em-row"><div class="em-time is-rescued"><span class="em-time-text">${timeText}</span> üí°</div></div>`;
            else rowsHtml += `<div class="em-row"><div class="em-time is-off">${timeText}</div></div>`;
        });

        captureTarget.innerHTML = `${bgHtml}<div style="position:relative; z-index:2;">${getStandardHeader(lastDateStr)}</div><div class="emoji-content-wrapper"><div class="em-rows">${rowsHtml}</div></div>${getStandardFooter()}`;
    }

    // === –ü–õ–Æ–®–ö–ò ===
    function updateCopyText() {
        const header = getHeaderTitle(lastDateStr);
        finalTextDiv.textContent = `**${header}**\n\n${lastTextIntervals}\n\nü§ñ–ù–∞–ø–∏—Å–∞—Ç–∏ (–º–æ–∂–Ω–∞ –∞–Ω–æ–Ω—ñ–º–Ω–æ): @valkysho_bot\nüí¨ –ß–∞—Ç: t.me/valkychat\nüì£ –ë–∞–∑–∞—Ä—á–∏–∫: t.me/valkybazar`;
        copyBlock.classList.remove('copied');
        copyHint.textContent = "–¢–∞–ø–Ω–∏, —â–æ–± —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ —Ç–µ–∫—Å—Ç";
        copyHint.style.color = "#007aff";
    }

    function generateImageOutput() {
        html2canvas(captureTarget, {
            scale: 3, backgroundColor: null, logging: false, useCORS: true
        }).then(canvas => {
            generatedImage.src = canvas.toDataURL('image/png');
        });
    }

    function copyToClipboard() {
        navigator.clipboard.writeText(finalTextDiv.textContent).then(() => {
            copyBlock.classList.add('copied');
            copyHint.textContent = "–°–ö–û–ü–Ü–ô–û–í–ê–ù–û! ‚úÖ";
            copyHint.style.color = "#28a745";
            if(navigator.vibrate) navigator.vibrate(50);
        }).catch(err => alert("–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ. –°–ø—Ä–æ–±—É–π –≤—Ä—É—á–Ω—É."));
    }

    async function saveImageToGallery() {
        if (!generatedImage.src) return;
        try {
            const response = await fetch(generatedImage.src);
            const blob = await response.blob();
            const file = new File([blob], "grafik_valky.png", { type: "image/png" });
            if (navigator.share) { await navigator.share({ files: [file] }); } 
            else { const link = document.createElement("a"); link.href = generatedImage.src; link.download = "grafik_valky.png"; document.body.appendChild(link); link.click(); document.body.removeChild(link); }
        } catch (err) { alert("–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è. –°–ø—Ä–æ–±—É–π –∑—Ä–æ–±–∏—Ç–∏ —Å–∫—Ä—ñ–Ω—à–æ—Ç."); }
    }

    function clearAll() {
        document.getElementById('rawText').value = '';
        captureTarget.innerHTML = '';
        globalIntervals = [];
        editorWrapper.style.display = 'none';
        outputWrapper.style.display = 'none';
    }
</script>

</body>
</html>