<!DOCTYPE html>

<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ELECTRIFY ‚Ä¢ ADMIN</title>
    <style>
            :root { 
        --bg-app: #f4f5f7; 
        --text-main: #1d1d1f; 
        --radius: 16px; 
        --c-yellow: #f59e0b; 
        --c-red: #ef4444; 
        --c-green: #10b981; 
        --border-line: rgba(0,0,0,0.08);
    }
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg-app); color: var(--text-main); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
    .app-container { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 20px; }
    
    /* –ß–∏—Å—Ç–∞ –∫–∞—Ä—Ç–∫–∞ –±–µ–∑ –º–∏–ª–∞ */
    .card { background: #ffffff; padding: 25px; border-radius: var(--radius); border: 1px solid var(--border-line); box-shadow: 0 8px 30px rgba(0,0,0,0.04); }
    
    h2 { margin: 0 0 5px 0; font-weight: 900; color: #333; letter-spacing: -0.5px; display: flex; align-items: center; justify-content: space-between; }
    .subtitle { font-size: 12px; color: #888; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; }
    .form-label { font-size: 12px; font-weight: bold; color: #666; margin-left: 5px; display: block; margin-bottom: 8px; text-transform: uppercase; }
    
    /* –Ü–Ω–ø—É—Ç–∏ —ñ –∫–Ω–æ–ø–∫–∏ —Ç–µ–ø–µ—Ä –ø–ª–æ—Å–∫—ñ —ñ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ñ */
    .input-neumorph { width: 100%; border: 1.5px solid var(--border-line); border-radius: 12px; padding: 15px; font-family: inherit; background: #fafafa; color: #333; outline: none; transition: 0.2s; font-weight: 600; }
    .input-neumorph:focus { border-color: #333; background: #fff; }
    textarea.input-neumorph { height: 100px; resize: none; margin-bottom: 15px; }
    
    .btn-neu { width: 100%; padding: 16px; border: 1px solid var(--border-line); border-radius: 12px; font-weight: 800; font-size: 15px; cursor: pointer; background: #ffffff; color: #333; transition: all 0.2s ease; display: flex; justify-content: center; align-items: center; gap: 8px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
    .btn-neu:active { transform: scale(0.98); background: #f0f0f0; }
    .btn-primary { color: #007aff; }
    .btn-danger { color: #ff3b30; }
    .btn-success { color: var(--c-green); font-size: 18px; padding: 20px; }

    .loader-screen { text-align: center; padding: 40px 20px; color: #888; font-weight: 700; font-size: 14px; }

    /* –ü—ñ–≥—É–ª–∫–∏ –∫—Ä–æ–∫—ñ–≤ —Ç–µ–∂ –∑—Ä–æ–±–∏–≤ flat */
    .step-indicator { display: flex; gap: 8px; margin-bottom: 20px; }
    .step-pill { flex: 1; padding: 8px; border-radius: 10px; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; text-align: center; background: #ffffff; border: 1px solid var(--border-line); color: #aaa; transition: 0.2s; }
    .step-pill.active { background: #333; color: #fff; border-color: #333; }
    .step-pill.done { color: var(--c-green); border-color: rgba(40, 167, 69, 0.3); background: rgba(40, 167, 69, 0.05); }

    .today-banner { background: rgba(40, 167, 69, 0.1); border: 2px solid var(--c-green); border-radius: 12px; padding: 14px 16px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .today-banner-text { font-size: 13px; font-weight: 700; color: #1e7e34; line-height: 1.4; }
    .today-banner-date { font-size: 11px; color: #555; font-weight: 600; margin-top: 2px; }
    .today-banner button { background: #333; color: #fff; border: none; border-radius: 8px; padding: 7px 12px; font-weight: 800; font-size: 12px; cursor: pointer; flex-shrink: 0; }

    .section-divider { height: 1px; background: var(--border-line); margin: 20px 0; }

    /* –¢–∞–π–º–ª–∞–π–Ω-—Ä–µ–¥–∞–∫—Ç–æ—Ä: —Ç–µ–ø–µ—Ä —á—ñ—Ç–∫–æ –≤–∏–¥–Ω–æ –∫–∞—Ä—Ç–∫–∏ */
    .timeline-editor { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
    .tl-row { display: flex; align-items: center; gap: 10px; padding: 12px 14px; border-radius: 12px; background: #ffffff; border: 1px solid var(--border-line); cursor: pointer; user-select: none; transition: 0.15s; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
    .tl-row:active { transform: scale(0.98); background: #fafafa; }
    .tl-row.type-on { border-left: 4px solid var(--c-yellow); }
    .tl-row.type-off { border-left: 4px solid #999; }
    .tl-row.type-emergency { border-left: 4px solid var(--c-red); background: rgba(239, 68, 68, 0.05); }
    .tl-row.fact-modified { opacity: 0.9; }
    
    .tl-time { font-size: 15px; font-weight: 800; color: #333; min-width: 110px; letter-spacing: -0.3px; }
    .tl-badges { display: flex; flex-wrap: wrap; gap: 5px; flex: 1; }
    .tl-badge { font-size: 11px; font-weight: 800; padding: 4px 8px; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.3px; }
    .tl-badge.plan-on { background: rgba(245, 158, 11, 0.15); color: #b45309; border: 1px solid rgba(245, 158, 11, 0.3); }
    .tl-badge.plan-off { background: #f0f0f0; color: #666; border: 1px solid #ddd; }
    .tl-badge.fact-on { background: rgba(16, 185, 129, 0.12); color: #047857; border: 1px solid rgba(16, 185, 129, 0.3); }
    .tl-badge.fact-emergency { background: rgba(239, 68, 68, 0.12); color: var(--c-red); border: 1px solid rgba(239, 68, 68, 0.3); }
    .tl-badge.strikethrough { text-decoration: line-through; opacity: 0.5; }
    .tl-arrow { font-size: 12px; color: #bbb; flex-shrink: 0; }


    .fact-modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 200; align-items: flex-end; justify-content: center; }
    .fact-modal-overlay.open { display: flex; }
    .fact-modal { background: var(--bg-app); border-radius: 20px 20px 0 0; padding: 25px; width: 100%; max-width: 500px; box-shadow: 0 -10px 40px rgba(0,0,0,0.2); }
    .fact-modal h3 { margin: 0 0 5px 0; font-size: 16px; font-weight: 900; color: #333; }
    .fact-modal .modal-time { font-size: 13px; color: #888; font-weight: 600; margin-bottom: 20px; }
    .fact-options { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
    .fact-option { padding: 14px 16px; border-radius: 12px; border: 2px solid transparent; cursor: pointer; font-weight: 700; font-size: 14px; background: var(--bg-app); box-shadow: 4px 4px 8px var(--neumorph-shadow-dark), -4px -4px 8px var(--neumorph-shadow-light); transition: 0.15s; display: flex; align-items: center; gap: 10px; }
    .fact-option:active { transform: scale(0.98); }
    .fact-option.selected { box-shadow: none; }
    .fact-option.opt-plan { color: #555; }
    .fact-option.opt-on { border-color: var(--c-yellow); color: #b45309; }
    .fact-option.opt-on.selected { background: rgba(251,191,36,0.15); }
    .fact-option.opt-off { border-color: #999; color: #555; }
    .fact-option.opt-off.selected { background: rgba(0,0,0,0.05); }
    .fact-option.opt-emergency { border-color: var(--c-red); color: var(--c-red); }
    .fact-option.opt-emergency.selected { background: rgba(217,70,59,0.08); }
    .em-time-inputs { display: flex; gap: 10px; margin-top: 10px; display: none; }
    .em-time-inputs.visible { display: flex; }
    .em-time-inputs input { flex: 1; border: none; border-radius: 10px; padding: 12px; font-family: inherit; background: var(--bg-app); box-shadow: inset 4px 4px 8px var(--neumorph-shadow-dark), inset -4px -4px 8px var(--neumorph-shadow-light); color: #333; outline: none; font-weight: 700; text-align: center; font-size: 15px; }
    .modal-btns { display: flex; gap: 10px; }
    .modal-btns button { flex: 1; padding: 14px; border: none; border-radius: 12px; font-weight: 800; font-size: 14px; cursor: pointer; }
    .modal-btn-cancel { background: var(--bg-app); color: #888; box-shadow: 4px 4px 8px var(--neumorph-shadow-dark), -4px -4px 8px var(--neumorph-shadow-light); }
    .modal-btn-save { background: #333; color: #fff; }

    .copy-block { padding: 20px; border-radius: 15px; background: rgba(255,255,255,0.5); cursor: pointer; text-align: left; margin-bottom: 20px; border: 1px dashed #aaa; }
    .copy-content { font-family: monospace; font-size: 13px; color: #333; white-space: pre-wrap; pointer-events: none; }

    .autosave-hint { font-size: 11px; color: #aaa; text-align: center; margin-bottom: 10px; font-weight: 600; }
    .autosave-hint.saving { color: #007aff; }
    .autosave-hint.saved { color: var(--c-green); }
</style>


</head>
<body>
<div class="app-container">
    <div class="card">
        <h2>‚ö° ELECTRIFY <span style="font-size:12px; background:#333; color:#fff; padding:2px 8px; border-radius:10px;">ADMIN</span></h2>


    <div id="loaderScreen" class="loader-screen">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>

    <div id="mainUI" style="display:none;">

        <div class="step-indicator">
            <div class="step-pill" id="pill1">üìã –ü–ª–∞–Ω</div>
            <div class="step-pill" id="pill2">‚úèÔ∏è –§–∞–∫—Ç</div>
            <div class="step-pill" id="pill3">üöÄ –ü—É–±–ª—ñ–∫–∞—Ü—ñ—è</div>
        </div>

        <div id="todayBanner" style="display:none;" class="today-banner">
            <div>
                <div class="today-banner-text">‚úÖ –ì—Ä–∞—Ñ—ñ–∫ –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ –≤–∂–µ —î</div>
                <div class="today-banner-date" id="todayBannerDate"></div>
            </div>
            <button onclick="resetPlan()">–ù–æ–≤–∏–π</button>
        </div>

        <div id="step1" style="display:none;">
            <div class="subtitle">–ö—Ä–æ–∫ 1 ‚Äî –í—Å—Ç–∞–≤–∏—Ç–∏ —Ç–µ–∫—Å—Ç –≤—ñ–¥ –û–±–ª–µ–Ω–µ—Ä–≥–æ</div>
            <textarea id="rawText" class="input-neumorph" placeholder="–í—Å—Ç–∞–≤ —Ç–µ–∫—Å—Ç –≥—Ä–∞—Ñ—ñ–∫—É –≤—ñ–¥ –û–±–ª–µ–Ω–µ—Ä–≥–æ —Å—é–¥–∏..."></textarea>
            <div style="display:flex; gap:10px;">
                <button class="btn-neu btn-primary" onclick="processData()" style="margin:0;">üîÑ –û–±—Ä–æ–±–∏—Ç–∏</button>
                <button class="btn-neu btn-danger" style="flex:0.3; margin:0;" onclick="clearRaw()">‚ùå</button>
            </div>
        </div>

        <div id="step2" style="display:none;">
            <div class="section-divider"></div>
            <div class="subtitle">–ö—Ä–æ–∫ 2 ‚Äî –§–∞–∫—Ç–∏—á–Ω—ñ –∫–æ—Ä–µ–∫—Ç–∏–≤–∏</div>
            <div class="form-label">–¢–∞–ø–Ω–∏ –Ω–∞ –±–ª–æ–∫ —â–æ–± –∑–º—ñ–Ω–∏—Ç–∏ —Ñ–∞–∫—Ç–∏—á–Ω–∏–π —Å—Ç–∞–Ω:</div>
            <div class="timeline-editor" id="timelineEditor"></div>
        </div>

        <div id="step3" style="display:none;">
            <div class="section-divider"></div>
            <div class="subtitle">–ö—Ä–æ–∫ 3 ‚Äî –ü—É–±–ª—ñ–∫–∞—Ü—ñ—è</div>
            <div class="copy-block" onclick="copyToClipboard()">
                <div class="copy-content" id="finalText">–¢–µ–∫—Å—Ç –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è...</div>
                <div style="font-size:11px; color:#007aff; margin-top:10px; font-weight:bold; text-align:center;" id="copyHint">–¢–ê–ü–ù–ò, –©–û–ë –°–ö–û–ü–Ü–Æ–í–ê–¢–ò –ü–û–°–¢</div>
            </div>
            <div class="autosave-hint" id="autosaveHint">–ê–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–µ</div>
            <button class="btn-neu btn-success" id="btnPush" onclick="pushToMiniApp()" style="margin:0;">üöÄ –û–ü–£–ë–õ–Ü–ö–£–í–ê–¢–ò –í –î–û–î–ê–¢–ö–£</button>
            <button class="btn-neu" onclick="resetToWaiting()" style="margin-top:15px; color:#ff3b30; border:2px dashed rgba(255,59,48,0.3);">üóë –¢–∞–Ω–æ—Å –≥—Ä–∞—Ñ—ñ–∫—É (–û—á—ñ–∫—É–≤–∞–Ω–Ω—è)</button>
        </div>

    </div>
</div>


</div>

<div class="fact-modal-overlay" id="factModalOverlay" onclick="closeModalOnOverlay(event)">
    <div class="fact-modal">
        <h3 id="modalTitle">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –±–ª–æ–∫</h3>
        <div class="modal-time" id="modalTime"></div>
        <div class="fact-options" id="factOptions"></div>
        <div class="em-time-inputs" id="emTimeInputs">
            <input type="text" id="emStartInput" placeholder="–ü–æ—á–∞—Ç–æ–∫ (11:30)">
            <input type="text" id="emEndInput" placeholder="–ö—ñ–Ω–µ—Ü—å (15:30)">
        </div>
        <div class="modal-btns">
            <button class="modal-btn-cancel" onclick="closeModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            <button class="modal-btn-save" onclick="saveModal()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
        </div>
    </div>
</div>

<script>
    const BIN_PUBLIC = '699b325fd0ea881f40cf7aaf';
    const BIN_EDITOR = '699c6dc443b1c97be996cd61';
    const API_KEY = '$2a$10$LtEcs8xMXZsRCDbVKHwou..M4xtkpoEM/3CJuf76Q0gK3gZ0I607C';

    let lastDateStr = "–°–¨–û–ì–û–î–ù–Ü";
    let globalIntervals = [];
    let activeEmergency = null;
    let autosaveTimer = null;
    let editingIndex = null;
    let selectedFactType = null;

    function timeToMinutes(t) { const [h, m] = t.replace(/[^\d:]/g, '').split(':').map(Number); return (h || 0) * 60 + (m || 0); }
    function minutesToTime(mins) { const h = Math.floor(mins / 60); const m = mins % 60; return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`; }
    function getClockEmoji(timeStr) { let [h, m] = timeStr.split(':').map(Number); if (isNaN(m)) m = 0; let h12 = h % 12 || 12; const f = ['üïõ','üïê','üïë','üïí','üïì','üïî','üïï','üïñ','üïó','üïò','üïô','üïö']; const h_em = ['üïß','üïú','üïù','üïû','üïü','üï†','üï°','üï¢','üï£','üï§','üï•','üï¶']; return (m >= 30) ? h_em[h12 === 12 ? 0 : h12] : f[h12 === 12 ? 0 : h12]; }
    function todayStr() { return new Date().toLocaleDateString('uk-UA', { day: 'numeric', month: 'long' }).toUpperCase(); }

    async function init() {
        try {
            const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_EDITOR}/latest`, { headers: { 'X-Master-Key': API_KEY } });
            const data = (await res.json()).record;

            if (data && data.date && data.intervals && data.intervals.length > 0) {
                const today = todayStr();
                if (data.date === today || data.dateRaw === lastDateStr) {
                    lastDateStr = data.date;
                    globalIntervals = data.intervals;
                    activeEmergency = data.emergency && data.emergency.active ? data.emergency : null;
                    showTodayBanner();
                    showStep2();
                    showStep3();
                } else {
                    showStep1();
                }
            } else {
                showStep1();
            }
        } catch(e) {
            showStep1();
        }
        document.getElementById('loaderScreen').style.display = 'none';
        document.getElementById('mainUI').style.display = 'block';
    }

    function showStep1() {
        document.getElementById('step1').style.display = 'block';
        document.getElementById('step2').style.display = 'none';
        document.getElementById('step3').style.display = 'none';
        document.getElementById('todayBanner').style.display = 'none';
        setPill(1);
    }

    function showStep2() {
        document.getElementById('step2').style.display = 'block';
        document.getElementById('step3').style.display = 'block';
        renderTimelineEditor();
        buildPostText();
        setPill(2);
    }

    function showTodayBanner() {
        const banner = document.getElementById('todayBanner');
        banner.style.display = 'flex';
        document.getElementById('todayBannerDate').textContent = lastDateStr;
    }

    function setPill(active) {
        [1,2,3].forEach(i => {
            const p = document.getElementById('pill' + i);
            p.classList.remove('active','done');
            if (i < active) p.classList.add('done');
            if (i === active) p.classList.add('active');
        });
    }

    function processData() {
        const text = document.getElementById('rawText').value;
        const dateMatch = text.match(/(\d{1,2})\s+(—Å—ñ—á–Ω—è|–ª—é—Ç–æ–≥–æ|–±–µ—Ä–µ–∑–Ω—è|–∫–≤—ñ—Ç–Ω—è|—Ç—Ä–∞–≤–Ω—è|—á–µ—Ä–≤–Ω—è|–ª–∏–ø–Ω—è|—Å–µ—Ä–ø–Ω—è|–≤–µ—Ä–µ—Å–Ω—è|–∂–æ–≤—Ç–Ω—è|–ª–∏—Å—Ç–æ–ø–∞–¥–∞|–≥—Ä—É–¥–Ω—è)/i);
        if (dateMatch) lastDateStr = dateMatch[0].toUpperCase();

        const match = text.match(/(?:^|\n)\s*1\.2\s+([^\n]+)/);
        if (!match) { alert("–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ —á–µ—Ä–≥—É 1.2!"); return; }

        let tempOutages = [];
        match[1].trim().split(';').forEach(range => {
            let parts = range.split(/[-‚Äì‚Äî]/);
            if (parts.length < 2) return;
            let sM = timeToMinutes(parts[0].trim());
            let eM = timeToMinutes(parts[1].trim());
            if (eM === 0 || parts[1].trim() === "24:00") eM = 1440;
            if (eM < sM) eM = 1440;
            tempOutages.push({ startMin: sM, endMin: eM, startStr: parts[0].trim(), displayEndStr: (parts[1].trim() === "24:00" || eM === 1440 ? "00:00" : parts[1].trim()) });
        });
        tempOutages.sort((a, b) => a.startMin - b.startMin);

        globalIntervals = [];
        let cT = 0;
        tempOutages.forEach(outage => {
            if (cT < outage.startMin) globalIntervals.push({ planType: 'on', factType: null, startMin: cT, endMin: outage.startMin, startStr: minutesToTime(cT), displayEndStr: minutesToTime(outage.startMin) });
            globalIntervals.push({ planType: 'off', factType: null, startMin: outage.startMin, endMin: outage.endMin, startStr: outage.startStr, displayEndStr: outage.displayEndStr });
            cT = outage.endMin;
        });
        if (cT < 1440) globalIntervals.push({ planType: 'on', factType: null, startMin: cT, endMin: 1440, startStr: minutesToTime(cT), displayEndStr: "00:00" });

        activeEmergency = null;
        document.getElementById('step1').style.display = 'none';
        showTodayBanner();
        showStep2();
        autoSave();
    }

    function renderTimelineEditor() {
        const container = document.getElementById('timelineEditor');
        container.innerHTML = '';

        globalIntervals.forEach((int, i) => {
            const row = document.createElement('div');
            const displayType = int.factType || int.planType;
            row.className = `tl-row type-${displayType}${int.factType ? ' fact-modified' : ''}`;

            const planBadgeClass = int.planType === 'on' ? 'plan-on' : 'plan-off';
            const planLabel = int.planType === 'on' ? 'üí° –°–≤—ñ—Ç–ª–æ' : 'üåë –í—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è';
            let planBadgeStyle = int.factType && int.factType !== int.planType ? 'strikethrough' : '';

            let factBadgeHtml = '';
            if (int.factType && int.factType !== int.planType) {
                if (int.factType === 'on') factBadgeHtml = `<span class="tl-badge fact-on">‚úÖ –°–≤—ñ—Ç–ª–æ –±—É–ª–æ</span>`;
                if (int.factType === 'off') factBadgeHtml = `<span class="tl-badge plan-off">‚õî –°–∫–∞—Å–æ–≤–∞–Ω–æ</span>`;
            }
            if (int.factType === 'emergency') {
                factBadgeHtml = `<span class="tl-badge fact-emergency">‚õîÔ∏è –ê–≤–∞—Ä—ñ–π–Ω–µ${int.emStart ? ` ${int.emStart}‚Äì${int.emEnd}` : ''}</span>`;
            }

            row.innerHTML = `
                <div class="tl-time">${int.startStr} ‚Äì ${int.displayEndStr}</div>
                <div class="tl-badges">
                    <span class="tl-badge ${planBadgeClass} ${planBadgeStyle}">${planLabel}</span>
                    ${factBadgeHtml}
                </div>
                <div class="tl-arrow">‚Ä∫</div>`;
            row.onclick = () => openModal(i);
            container.appendChild(row);
        });
    }

    function openModal(index) {
        editingIndex = index;
        const int = globalIntervals[index];
        selectedFactType = int.factType || 'plan';

        document.getElementById('modalTitle').textContent = `${int.startStr} ‚Äì ${int.displayEndStr}`;
        document.getElementById('modalTime').textContent = `–ü–æ –≥—Ä–∞—Ñ—ñ–∫—É: ${int.planType === 'on' ? 'üí° –°–≤—ñ—Ç–ª–æ' : 'üåë –í—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è'}`;

        const opts = document.getElementById('factOptions');
        opts.innerHTML = `
            <div class="fact-option opt-plan ${selectedFactType === 'plan' ? 'selected' : ''}" onclick="selectFact('plan')">
                üìã –ó–∞ –≥—Ä–∞—Ñ—ñ–∫–æ–º (–±–µ–∑ –∑–º—ñ–Ω)
            </div>
            <div class="fact-option opt-on ${selectedFactType === 'on' ? 'selected' : ''}" onclick="selectFact('on')">
                üí° –§–∞–∫—Ç–∏—á–Ω–æ —Å–≤—ñ—Ç–ª–æ –±—É–ª–æ
            </div>
            <div class="fact-option opt-off ${selectedFactType === 'off' ? 'selected' : ''}" onclick="selectFact('off')">
                üåë –§–∞–∫—Ç–∏—á–Ω–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –±—É–ª–æ
            </div>
            <div class="fact-option opt-emergency ${selectedFactType === 'emergency' ? 'selected' : ''}" onclick="selectFact('emergency')">
                ‚õîÔ∏è –ê–≤–∞—Ä—ñ–π–Ω–µ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
            </div>`;

        const emInputs = document.getElementById('emTimeInputs');
        if (selectedFactType === 'emergency') {
            emInputs.classList.add('visible');
            document.getElementById('emStartInput').value = int.emStart || int.startStr;
            document.getElementById('emEndInput').value = int.emEnd || int.displayEndStr;
        } else {
            emInputs.classList.remove('visible');
        }

        document.getElementById('factModalOverlay').classList.add('open');
    }

    function selectFact(type) {
        selectedFactType = type;
        document.querySelectorAll('.fact-option').forEach(el => el.classList.remove('selected'));
        document.querySelector(`.opt-${type}`).classList.add('selected');
        const emInputs = document.getElementById('emTimeInputs');
        if (type === 'emergency') {
            emInputs.classList.add('visible');
            const int = globalIntervals[editingIndex];
            document.getElementById('emStartInput').value = int.emStart || int.startStr;
            document.getElementById('emEndInput').value = int.emEnd || int.displayEndStr;
        } else {
            emInputs.classList.remove('visible');
        }
    }

    function saveModal() {
        const int = globalIntervals[editingIndex];
        if (selectedFactType === 'plan') {
            int.factType = null;
            int.emStart = null;
            int.emEnd = null;
        } else if (selectedFactType === 'emergency') {
            int.factType = 'emergency';
            int.emStart = document.getElementById('emStartInput').value.trim() || int.startStr;
            int.emEnd = document.getElementById('emEndInput').value.trim() || int.displayEndStr;
            activeEmergency = { active: true, start: int.emStart, end: int.emEnd };
        } else {
            int.factType = selectedFactType;
            int.emStart = null;
            int.emEnd = null;
        }

        if (selectedFactType !== 'emergency') {
            const hasEmergency = globalIntervals.some(i => i.factType === 'emergency');
            if (!hasEmergency) activeEmergency = null;
        }

        closeModal();
        renderTimelineEditor();
        buildPostText();
        autoSave();
    }

    function closeModal() {
        document.getElementById('factModalOverlay').classList.remove('open');
        editingIndex = null;
    }

    function closeModalOnOverlay(e) {
        if (e.target === document.getElementById('factModalOverlay')) closeModal();
    }

    function buildPostText() {
        let lines = [];
        globalIntervals.forEach(int => {
            const fact = int.factType;
            const plan = int.planType;
            const t = `${int.startStr} - ${int.displayEndStr}`;

            if (fact === 'emergency') {
                lines.push(`${getClockEmoji(int.emStart || int.startStr)} ${int.emStart || int.startStr} - ${int.emEnd || int.displayEndStr} (–∞–≤–∞—Ä—ñ–π–Ω–µ ‚ö†Ô∏è)`);
            } else if (fact === 'on' && plan === 'off') {
                // –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Å–∫–∞—Å–æ–≤–∞–Ω–µ ‚Äî –Ω–µ –ø–æ–∫–∞–∑—É—î–º–æ (–±—É–ª–æ —Å–≤—ñ—Ç–ª–æ)
            } else if (fact === 'off' && plan === 'on') {
                lines.push(`${getClockEmoji(int.startStr)} ${t}`);
            } else if (plan === 'off' && !fact) {
                lines.push(`${getClockEmoji(int.startStr)} ${t}`);
            }
        });

        document.getElementById('finalText').textContent =
            `üí°‚ö°Ô∏è –ì–†–ê–§–Ü–ö –í–Ü–î–ö–õ–Æ–ß–ï–ù–¨ ${lastDateStr}\n\n${lines.join('\n')}\n\nüì±üÜï –î–∏–Ω–∞–º—ñ—á–Ω–∏–π –æ–Ω–ª–∞–π–Ω-–≥—Ä–∞—Ñ—ñ–∫ –≤ –Ω–∞—à–æ–º—É –º—ñ–Ω—ñ-–¥–æ–¥–∞—Ç–∫—É: t.me/valkyelectrifybot/electric\n\nüí¨ –ß–∞—Ç: t.me/valkychat\nüì£ –ë–∞–∑–∞—Ä—á–∏–∫: t.me/valkybazar`;
    }

        function buildPublicIntervals() {
        let result = [];
        globalIntervals.forEach(int => {
            const fact = int.factType;
            const plan = int.planType;

            if (fact === 'on' && plan === 'off') {
                // –í—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Å–∫–∞—Å–æ–≤–∞–Ω–µ, —Å–≤—ñ—Ç–ª–æ —î
                result.push({ type: 'off', isModified: true, startMin: int.startMin, endMin: int.endMin, startStr: int.startStr, displayEndStr: int.displayEndStr });
            } else if (fact === 'off' && plan === 'on') {
                // –°–≤—ñ—Ç–ª–æ –º–∞–ª–æ –±—É—Ç–∏, –∞–ª–µ –π–æ–≥–æ —Ä—É–±–∞–Ω—É–ª–∏ (–Ω–µ –∞–≤–∞—Ä—ñ–π–Ω–µ, –ø—Ä–æ—Å—Ç–æ —Ñ–∞–∫—Ç)
                result.push({ type: 'on', isModified: true, startMin: int.startMin, endMin: int.endMin, startStr: int.startStr, displayEndStr: int.displayEndStr });
            } else {
                // –ó–≤–∏—á–∞–π–Ω–∏–π –ø–ª–∞–Ω
                result.push({ type: plan, isModified: false, startMin: int.startMin, endMin: int.endMin, startStr: int.startStr, displayEndStr: int.displayEndStr });
            }
        });
        return result.sort((a, b) => a.startMin - b.startMin);
    }


    function autoSave() {
        const hint = document.getElementById('autosaveHint');
        hint.textContent = '–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...';
        hint.className = 'autosave-hint saving';
        clearTimeout(autosaveTimer);
        autosaveTimer = setTimeout(async () => {
            try {
                await fetch(`https://api.jsonbin.io/v3/b/${BIN_EDITOR}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
                    body: JSON.stringify({ date: lastDateStr, intervals: globalIntervals, emergency: activeEmergency || { active: false }, savedAt: new Date().toISOString() })
                });
                hint.textContent = '‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ';
                hint.className = 'autosave-hint saved';
            } catch(e) {
                hint.textContent = '‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è';
                hint.className = 'autosave-hint';
            }
        }, 1200);
    }

    async function pushToMiniApp() {
        if (!globalIntervals.length) return alert("–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö!");
        const btn = document.getElementById('btnPush');
        btn.textContent = "‚è≥ –í—ñ–¥–ø—Ä–∞–≤–∫–∞...";

        const publicIntervals = buildPublicIntervals();
        const emBlock = globalIntervals.find(i => i.factType === 'emergency');
        const emergencyPayload = emBlock
            ? { active: true, start: emBlock.emStart, end: emBlock.emEnd }
            : { active: false };

        try {
            const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_PUBLIC}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
                body: JSON.stringify({ date: lastDateStr, intervals: publicIntervals, emergency: emergencyPayload, updatedAt: new Date().toISOString() })
            });
            if (res.ok) alert("‚úÖ –û–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ!"); else alert("‚ùå –ü–æ–º–∏–ª–∫–∞!");
        } catch(e) { alert("‚ùå –ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è"); }
        finally { btn.textContent = "üöÄ –û–ü–£–ë–õ–Ü–ö–£–í–ê–¢–ò –í –î–û–î–ê–¢–ö–£"; }
    }

    function copyToClipboard() {
        navigator.clipboard.writeText(document.getElementById('finalText').textContent);
        document.getElementById('copyHint').textContent = "–°–ö–û–ü–Ü–ô–û–í–ê–ù–û! ‚úÖ";
    }

    function resetPlan() {
        if (!confirm("–ü–æ—á–∞—Ç–∏ –Ω–æ–≤–∏–π –¥–µ–Ω—å? –ü–æ—Ç–æ—á–Ω–∏–π –ø–ª–∞–Ω –±—É–¥–µ –æ—á–∏—â–µ–Ω–æ.")) return;
        globalIntervals = [];
        activeEmergency = null;
        document.getElementById('todayBanner').style.display = 'none';
        document.getElementById('step2').style.display = 'none';
        document.getElementById('step3').style.display = 'none';
        document.getElementById('step1').style.display = 'block';
        setPill(1);
    }

    function clearRaw() {
        document.getElementById('rawText').value = '';
    }

    async function resetToWaiting() {
        if (!confirm("–¢–æ—á–Ω–æ —Ö–æ—á–µ—à –∑–Ω–µ—Å—Ç–∏ –ø–æ—Ç–æ—á–Ω–∏–π –≥—Ä–∞—Ñ—ñ–∫?")) return;
        try {
            await fetch(`https://api.jsonbin.io/v3/b/${BIN_PUBLIC}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
                body: JSON.stringify({ date: "–û–ß–Ü–ö–£–Ñ–ú–û", intervals: [], emergency: { active: false }, updatedAt: new Date().toISOString() })
            });
            await fetch(`https://api.jsonbin.io/v3/b/${BIN_EDITOR}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
                body: JSON.stringify({})
            });
            alert("‚úÖ –ì—Ä–∞—Ñ—ñ–∫ –∑–Ω–µ—Å–µ–Ω–æ!");
            globalIntervals = [];
            activeEmergency = null;
            document.getElementById('todayBanner').style.display = 'none';
            document.getElementById('step2').style.display = 'none';
            document.getElementById('step3').style.display = 'none';
            document.getElementById('step1').style.display = 'block';
            setPill(1);
        } catch(e) { alert("‚ùå –ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è"); }
    }

    init();
</script>

</body>
</html>