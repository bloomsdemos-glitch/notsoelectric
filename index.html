<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ELECTRIFY ‚Ä¢ ADMIN</title>
    <style>
        :root { --bg-app: #e0e5ec; --text-main: #4a4a4a; --radius: 20px; --neumorph-shadow-light: #ffffff; --neumorph-shadow-dark: #a3b1c6; --c-yellow: #fbbf24; --c-red: #d9463b; --c-dark: #060606; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg-app); color: var(--text-main); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .app-container { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 20px; }
        .card { background: var(--bg-app); padding: 25px; border-radius: var(--radius); box-shadow: 9px 9px 16px var(--neumorph-shadow-dark), -9px -9px 16px var(--neumorph-shadow-light); border: 1px solid rgba(255,255,255,0.2); }
        h2 { margin: 0 0 5px 0; font-weight: 900; color: #333; letter-spacing: -0.5px; display: flex; align-items: center; justify-content: space-between;}
        .subtitle { font-size: 12px; color: #888; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; }
        .form-label { font-size: 12px; font-weight: bold; color: #666; margin-left: 5px; display: block; margin-bottom: 5px; text-transform: uppercase; }
        .input-neumorph { width: 100%; border: none; border-radius: 12px; padding: 15px; font-family: inherit; background: var(--bg-app); box-shadow: inset 6px 6px 10px var(--neumorph-shadow-dark), -6px -6px 10px var(--neumorph-shadow-light); box-sizing: border-box; color: #333; outline: none; transition: 0.3s; font-weight: 500; }
        textarea.input-neumorph { height: 100px; resize: none; margin-bottom: 15px;}
        .btn-neu { width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: 800; font-size: 15px; cursor: pointer; background: var(--bg-app); box-shadow: 6px 6px 10px var(--neumorph-shadow-dark), -6px -6px 10px var(--neumorph-shadow-light); color: #333; transition: all 0.2s ease; display: flex; justify-content: center; align-items: center; gap: 8px; margin-bottom: 15px;}
        .btn-neu:active { box-shadow: inset 4px 4px 8px var(--neumorph-shadow-dark), inset -4px -4px 8px var(--neumorph-shadow-light); transform: scale(0.98); }
        .btn-primary { color: #007aff; } .btn-danger { color: #ff3b30; } .btn-success { color: #28a745; font-size: 18px; padding: 20px;}
        
        #dashboardControls { display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(0,0,0,0.05); }
        .emergency-card { background: rgba(217, 70, 59, 0.1); border: 2px dashed var(--c-red); border-radius: 15px; padding: 20px; margin-bottom: 20px; }
        .emergency-card.active { background: var(--c-red); color: #fff; border-style: solid; }
        .em-inputs { display: flex; gap: 10px; margin-bottom: 15px; }
        .edit-chips-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px;}
        .edit-chip { padding: 8px 12px; border-radius: 8px; font-size: 13px; font-weight: 700; cursor: pointer; background: var(--bg-app); transition: 0.2s; user-select: none; box-shadow: 3px 3px 6px var(--neumorph-shadow-dark), -3px -3px 6px var(--neumorph-shadow-light); }
        .edit-chip:active { transform: scale(0.95); }
        .edit-chip.off-state { border: 2px solid #888; color: #888; }
        .edit-chip.on-state { border: 2px solid var(--c-yellow); color: var(--c-yellow); }
        .edit-chip.rescued { border-color: var(--c-yellow); background: var(--c-yellow); color: #000; box-shadow: none; }
        .edit-chip.emergency { border-color: var(--c-red); background: var(--c-red); color: #fff; box-shadow: none; }
        .copy-block { padding: 20px; border-radius: 15px; background: rgba(255,255,255,0.5); cursor: pointer; text-align: left; margin-bottom: 20px; border: 1px dashed #aaa;}
        .copy-content { font-family: monospace; font-size: 13px; color: #333; white-space: pre-wrap; pointer-events: none; }
    </style>
</head>
<body>
<div class="app-container">
    <div class="card">
        <h2>‚ö° ELECTRIFY <span style="font-size:12px; background:#333; color:#fff; padding:2px 8px; border-radius:10px;">ADMIN</span></h2>
        <div class="subtitle">–ö—Ä–æ–∫ 1: –í–≤–µ–¥–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö</div>
        <textarea id="rawText" class="input-neumorph" placeholder="–í—Å—Ç–∞–≤ —Ç–µ–∫—Å—Ç –≥—Ä–∞—Ñ—ñ–∫—É –≤—ñ–¥ –û–±–ª–µ–Ω–µ—Ä–≥–æ —Å—é–¥–∏..."></textarea>
        <div style="display: flex; gap: 10px;">
            <button class="btn-neu btn-primary" onclick="processData()" style="margin:0;">üîÑ –û–±—Ä–æ–±–∏—Ç–∏ —Ç–µ–∫—Å—Ç</button>
            <button class="btn-neu btn-danger" style="flex: 0.3; margin:0;" onclick="clearAll()">‚ùå</button>
        </div>

        <div id="dashboardControls">
            <div class="subtitle">–ö—Ä–æ–∫ 2: –ü–∞–Ω–µ–ª—å –∫–µ—Ä—É–≤–∞–Ω–Ω—è</div>
            
            <div class="emergency-card" id="emergencyBlock">
                <h3 style="margin: 0 0 10px 0; font-size: 16px;">üö® –ï–ö–°–¢–†–ï–ù–ê –ê–í–ê–†–Ü–Ø</h3>
                <div class="em-inputs">
                    <input type="text" id="emStart" class="input-neumorph" placeholder="–ó —è–∫–æ—ó (15:00)" style="padding: 10px; text-align:center;">
                    <input type="text" id="emEnd" class="input-neumorph" placeholder="–ü–æ —è–∫—É (18:00)" style="padding: 10px; text-align:center;">
                </div>
                <button class="btn-neu" id="btnEmToggle" onclick="toggleEmergency()" style="margin: 0; color: var(--c-red);">–£–≤—ñ–º–∫–Ω—É—Ç–∏ –∞–≤–∞—Ä—ñ—é</button>
            </div>

            <label class="form-label">–†–£–ß–ù–ï –†–ï–î–ê–ì–£–í–ê–ù–ù–Ø (–ö–ª—ñ–∫ –ø–æ –±–ª–æ–∫—É):</label>
            <div class="edit-chips-container" id="editorChips"></div>

            <div class="copy-block" id="copyBlock" onclick="copyToClipboard()">
                <div class="copy-content" id="finalText">–¢–µ–∫—Å—Ç –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è...</div>
                <div style="font-size:11px; color:#007aff; margin-top:10px; font-weight:bold; text-align:center;" id="copyHint">–¢–ê–ü–ù–ò, –©–û–ë –°–ö–û–ü–Ü–Æ–í–ê–¢–ò –ü–û–°–¢</div>
            </div>

            <button class="btn-neu btn-success" id="btnPush" onclick="pushToMiniApp()" style="margin:0;">üöÄ –û–ü–£–ë–õ–Ü–ö–£–í–ê–¢–ò –í APP</button>
        </div>
    </div>
</div>

<script>
const BIN_ID = '699b325fd0ea881f40cf7aaf'; 
        const API_KEY = '$2a$10$LtEcs8xMXZsRCDbVKHwou..M4xtkpoEM/3CJuf76Q0gK3gZ0I607C';

    let lastDateStr = "–°–¨–û–ì–û–î–ù–Ü";
    let globalIntervals = [];
    let isEmergencyActive = false;

    function timeToMinutes(timeStr) { const [h, m] = timeStr.replace(/[^\d:]/g, '').split(':').map(Number); return (h || 0) * 60 + (m || 0); }
    function minutesToTime(mins) { const h = Math.floor(mins / 60); const m = mins % 60; return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`; }
    function getClockEmoji(timeStr) { let [h, m] = timeStr.split(':').map(Number); if(isNaN(m)) m=0; let h12 = h%12||12; const f=['üïõ','üïê','üïë','üïí','üïì','üïî','üïï','üïñ','üïó','üïò','üïô','üïö']; const h_em=['üïß','üïú','üïù','üïû','üïü','üï†','üï°','üï¢','üï£','üï§','üï•','üï¶']; return (m>=30)?h_em[h12===12?0:h12]:f[h12===12?0:h12]; }

    function processData() {
        const text = document.getElementById('rawText').value;
        const dateMatch = text.match(/(\d{1,2})\s+(—Å—ñ—á–Ω—è|–ª—é—Ç–æ–≥–æ|–±–µ—Ä–µ–∑–Ω—è|–∫–≤—ñ—Ç–Ω—è|—Ç—Ä–∞–≤–Ω—è|—á–µ—Ä–≤–Ω—è|–ª–∏–ø–Ω—è|—Å–µ—Ä–ø–Ω—è|–≤–µ—Ä–µ—Å–Ω—è|–∂–æ–≤—Ç–Ω—è|–ª–∏—Å—Ç–æ–ø–∞–¥–∞|–≥—Ä—É–¥–Ω—è)/i);
        if(dateMatch) lastDateStr = dateMatch[0].toUpperCase();

        const match = text.match(/(?:^|\n)\s*1\.2\s+([^\n]+)/);
        if (!match) { alert("–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ —á–µ—Ä–≥—É 1.2!"); return; }

        let tempOutages = [];
        match[1].trim().split(';').forEach(range => {
            let parts = range.split(/[\-\‚Äì\‚Äî]/); if (parts.length < 2) return;
            let sM = timeToMinutes(parts[0].trim()); let eM = timeToMinutes(parts[1].trim());
            if (eM === 0 || parts[1].trim() === "24:00") eM = 1440; if (eM < sM) eM = 1440; 
            tempOutages.push({ startMin: sM, endMin: eM, startStr: parts[0].trim(), displayEndStr: (parts[1].trim() === "24:00" || eM === 1440 ? "00:00" : parts[1].trim()) });
        });
        tempOutages.sort((a, b) => a.startMin - b.startMin);

        globalIntervals = []; let cT = 0;
        tempOutages.forEach(outage => {
            if (cT < outage.startMin) globalIntervals.push({ type: 'on', isModified: false, startMin: cT, endMin: outage.startMin, startStr: minutesToTime(cT), displayEndStr: minutesToTime(outage.startMin) });
            globalIntervals.push({ type: 'off', isModified: false, startMin: outage.startMin, endMin: outage.endMin, displayEndStr: outage.displayEndStr, startStr: outage.startStr });
            cT = outage.endMin;
        });
        if (cT < 1440) globalIntervals.push({ type: 'on', isModified: false, startMin: cT, endMin: 1440, startStr: minutesToTime(cT), displayEndStr: "00:00" });

        updateUI();
        document.getElementById('dashboardControls').style.display = 'block';
    }

    function updateUI() {
        const chips = document.getElementById('editorChips'); chips.innerHTML = '';
        let textInts = [];
        globalIntervals.forEach((int) => {
            let t = `${int.startStr} - ${int.displayEndStr}`;
            const btn = document.createElement('div');
            btn.className = `edit-chip ${int.type==='off' ? (int.isModified?'rescued':'off-state') : (int.isModified?'emergency':'on-state')}`;
            btn.innerHTML = `${int.type==='off'?'üåë':'üí°'} ${t} ${int.isModified?(int.type==='off'?'üí°':'‚ö†Ô∏è'):''}`;
            btn.onclick = () => { int.isModified = !int.isModified; updateUI(); };
            chips.appendChild(btn);

            if ((int.type==='off'&&!int.isModified) || (int.type==='on'&&int.isModified)) {
                textInts.push(`${getClockEmoji(int.startStr)} ${t}${(int.type==='on')?" (–∞–≤–∞—Ä—ñ–π–Ω–µ ‚ö†Ô∏è)":""}`);
            }
        });
        document.getElementById('finalText').textContent = `**–ì–†–ê–§–Ü–ö –í–Ü–î–ö–õ–Æ–ß–ï–ù–¨ [${lastDateStr}]**\n\n${textInts.join('\n')}\n\n‚ö°Ô∏è –Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏–π –≥—Ä–∞—Ñ—ñ–∫: https://t.me/valkyelectrifybot/grafik\n\nüí¨ –ß–∞—Ç: t.me/valkychat\nüì£ –ë–∞–∑–∞—Ä—á–∏–∫: t.me/valkybazar`;
    }

    function toggleEmergency() {
        isEmergencyActive = !isEmergencyActive;
        const block = document.getElementById('emergencyBlock'); const btn = document.getElementById('btnEmToggle');
        if(isEmergencyActive) { block.classList.add('active'); btn.textContent = "‚úÖ –í–∏–º–∫–Ω—É—Ç–∏ –∞–≤–∞—Ä—ñ—é"; btn.style.color = "#333"; } 
        else { block.classList.remove('active'); btn.textContent = "–£–≤—ñ–º–∫–Ω—É—Ç–∏ –∞–≤–∞—Ä—ñ—é"; btn.style.color = "var(--c-red)"; document.getElementById('emStart').value = ""; document.getElementById('emEnd').value = ""; }
    }

    async function pushToMiniApp() {
        if (!globalIntervals.length) return alert("–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö!");
        const btn = document.getElementById('btnPush'); btn.textContent = "‚è≥ –í—ñ–¥–ø—Ä–∞–≤–∫–∞...";
        try {
            const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                method: 'PUT', headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
                body: JSON.stringify({ date: lastDateStr, intervals: globalIntervals, emergency: { active: isEmergencyActive, start: document.getElementById('emStart').value.trim(), end: document.getElementById('emEnd').value.trim() }, updatedAt: new Date().toISOString() })
            });
            if(res.ok) alert("‚úÖ –û–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ!"); else alert("‚ùå –ü–æ–º–∏–ª–∫–∞!");
        } catch(e) { alert("‚ùå –ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è"); } finally { btn.textContent = "üöÄ –û–ü–£–ë–õ–Ü–ö–£–í–ê–¢–ò –í APP"; }
    }

    function copyToClipboard() { navigator.clipboard.writeText(document.getElementById('finalText').textContent); document.getElementById('copyHint').textContent = "–°–ö–û–ü–Ü–ô–û–í–ê–ù–û! ‚úÖ"; }
    function clearAll() { document.getElementById('rawText').value=''; globalIntervals=[]; isEmergencyActive=false; document.getElementById('dashboardControls').style.display='none'; document.getElementById('emergencyBlock').classList.remove('active'); document.getElementById('btnEmToggle').textContent="–£–≤—ñ–º–∫–Ω—É—Ç–∏ –∞–≤–∞—Ä—ñ—é"; }
</script>
</body>
</html>
