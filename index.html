<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ELECTRIFY ‚Ä¢ ADMIN (Control Center)</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-app: #e0e5ec; --text-main: #4a4a4a; --radius: 20px;
            --neumorph-shadow-light: #ffffff; --neumorph-shadow-dark: #a3b1c6;
            --c-yellow: #fbbf24; --c-red: #d9463b; --c-dark: #060606;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg-app); color: var(--text-main); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .app-container { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 20px; }

        .card { background: var(--bg-app); padding: 25px; border-radius: var(--radius); box-shadow: 9px 9px 16px var(--neumorph-shadow-dark), -9px -9px 16px var(--neumorph-shadow-light); border: 1px solid rgba(255,255,255,0.2); }
        h2 { margin: 0 0 5px 0; font-weight: 900; color: #333; letter-spacing: -0.5px; display: flex; align-items: center; justify-content: space-between;}
        .subtitle { font-size: 12px; color: #888; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; }

        .form-group { margin-bottom: 15px; }
        .form-label { font-size: 12px; font-weight: bold; color: #666; margin-left: 5px; display: block; margin-bottom: 5px; }
        
        .input-neumorph { width: 100%; border: none; border-radius: 12px; padding: 15px; font-family: inherit; background: var(--bg-app); box-shadow: inset 6px 6px 10px var(--neumorph-shadow-dark), inset -6px -6px 10px var(--neumorph-shadow-light); box-sizing: border-box; color: #333; outline: none; transition: 0.3s; font-weight: 500; }
        textarea.input-neumorph { height: 100px; resize: none; }

        .btn-neu { width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: 800; font-size: 15px; cursor: pointer; background: var(--bg-app); box-shadow: 6px 6px 10px var(--neumorph-shadow-dark), -6px -6px 10px var(--neumorph-shadow-light); color: #333; transition: all 0.2s ease; display: flex; justify-content: center; align-items: center; gap: 8px; margin-bottom: 15px;}
        .btn-neu:active { box-shadow: inset 4px 4px 8px var(--neumorph-shadow-dark), inset -4px -4px 8px var(--neumorph-shadow-light); transform: scale(0.98); }
        .btn-primary { color: #007aff; } 
        .btn-danger { color: #ff3b30; }
        .btn-success { color: #28a745; font-size: 18px; padding: 20px;}

        /* –ë–õ–û–ö –ê–í–ê–†–Ü–á */
        .emergency-card { background: rgba(217, 70, 59, 0.1); border: 2px dashed var(--c-red); border-radius: 15px; padding: 20px; margin-top: 10px; display: none; }
        .emergency-card.active { background: var(--c-red); color: #fff; border-style: solid; }
        .emergency-card.active .form-label { color: rgba(255,255,255,0.8); }
        .em-inputs { display: flex; gap: 10px; margin-bottom: 15px; }
        .em-inputs input { text-align: center; font-size: 18px; font-weight: 800; letter-spacing: 1px; }

        /* –ï–î–ò–¢–û–† –Ü–ù–¢–ï–†–í–ê–õ–Ü–í */
        #editorWrapper { display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(0,0,0,0.05); }
        .edit-chips-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .edit-chip { padding: 8px 12px; border-radius: 8px; font-size: 13px; font-weight: 700; cursor: pointer; background: var(--bg-app); transition: 0.2s; user-select: none; box-shadow: 3px 3px 6px var(--neumorph-shadow-dark), -3px -3px 6px var(--neumorph-shadow-light); display: flex; align-items: center; gap: 6px; }
        .edit-chip:active { transform: scale(0.95); }
        .edit-chip.off-state { border: 2px solid #888; color: #888; }
        .edit-chip.on-state { border: 2px solid var(--c-yellow); color: var(--c-yellow); }
        .edit-chip.rescued { border-color: var(--c-yellow); background: var(--c-yellow); color: #000; box-shadow: none; }
        .edit-chip.emergency { border-color: var(--c-red); background: var(--c-red); color: #fff; box-shadow: none; }

        /* –¢–ï–ö–°–¢ –ü–û–°–¢–£ */
        .copy-block { padding: 20px; border-radius: 15px; background: var(--bg-app); cursor: pointer; transition: all 0.2s; position: relative; user-select: none; box-shadow: 7px 7px 14px var(--neumorph-shadow-dark), -7px -7px 14px var(--neumorph-shadow-light); margin-bottom: 15px; display: none;}
        .copy-block:active { box-shadow: inset 5px 5px 10px var(--neumorph-shadow-dark), inset -5px -5px 10px var(--neumorph-shadow-light); transform: scale(0.99); }
        .copy-block.copied { background: #e3fae3; }
        .copy-content { font-family: monospace; font-size: 14px; color: #333; white-space: pre-wrap; line-height: 1.4; pointer-events: none; }
        .copy-hint { margin-top: 10px; font-size: 12px; color: #007aff; text-align: center; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

        /* –•–û–í–ê–ù–ö–ê –î–õ–Ø –ö–ê–†–¢–ò–ù–ö–ò */
        #imageGenBlock { display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(0,0,0,0.05); }
        #captureTarget { background: var(--c-dark); color: #ffffff; padding: 25px 30px; position: absolute; left: -9999px; top: 0; width: 600px; height: auto; box-sizing: border-box; -webkit-font-smoothing: antialiased; overflow: hidden; display: flex; flex-direction: column; }
        #generatedImage { width: 100%; border-radius: 12px; margin-top: 15px; display: none; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="card">
        <h2>‚ö° ELECTRIFY <span style="font-size:12px; background:#333; color:#fff; padding:2px 8px; border-radius:10px;">ADMIN</span></h2>
        <div class="subtitle">Control Center v2.0</div>

        <button class="btn-neu btn-success" id="btnPush" onclick="pushToMiniApp()" style="display: none;">üöÄ –û–ù–û–í–ò–¢–ò MINI APP</button>

        <textarea id="rawText" class="input-neumorph" placeholder="–í—Å—Ç–∞–≤ —Ç–µ–∫—Å—Ç –≥—Ä–∞—Ñ—ñ–∫—É –≤—ñ–¥ –û–±–ª–µ–Ω–µ—Ä–≥–æ —Å—é–¥–∏ (–∑ —á–µ—Ä–≥–æ—é 1.2)..."></textarea>
        
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="btn-neu btn-primary" onclick="processData()">üîÑ –û–±—Ä–æ–±–∏—Ç–∏ —Ç–µ–∫—Å—Ç</button>
            <button class="btn-neu btn-danger" style="flex: 0.3;" onclick="clearAll()">‚ùå</button>
        </div>

        <div class="emergency-card" id="emergencyBlock">
            <h3 style="margin: 0 0 10px 0; font-size: 16px;">üö® –ï–ö–°–¢–†–ï–ù–ê –ê–í–ê–†–Ü–Ø</h3>
            <div class="em-inputs">
                <div>
                    <label class="form-label">–ó —è–∫–æ—ó (–≥–æ–¥:—Ö–≤)</label>
                    <input type="text" id="emStart" class="input-neumorph" placeholder="15:00" style="padding: 10px;">
                </div>
                <div>
                    <label class="form-label">–ü–æ —è–∫—É (–æ–ø—Ü—ñ–æ–Ω.)</label>
                    <input type="text" id="emEnd" class="input-neumorph" placeholder="18:00" style="padding: 10px;">
                </div>
            </div>
            <button class="btn-neu" id="btnEmToggle" onclick="toggleEmergency()" style="margin: 0; color: var(--c-red);">–£–≤—ñ–º–∫–Ω—É—Ç–∏ –∞–≤–∞—Ä—ñ—é</button>
        </div>

        <div id="editorWrapper">
            <label class="form-label">–†–£–ß–ù–ï –†–ï–î–ê–ì–£–í–ê–ù–ù–Ø –ë–õ–û–ö–Ü–í (—è–∫—â–æ —Ç—Ä–µ–±–∞):</label>
            <div class="edit-chips-container" id="editorChips"></div>
        </div>
    </div>

    <div class="copy-block" id="copyBlock" onclick="copyToClipboard()">
        <div class="copy-content" id="finalText">–¢—É—Ç –±—É–¥–µ —Ç–µ–∫—Å—Ç...</div>
        <div class="copy-hint" id="copyHint">–¢–∞–ø–Ω–∏, —â–æ–± —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç—É</div>
    </div>

    <div class="card" id="imageGenBlock">
        <div class="subtitle">BACKUP: –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∫–∞—Ä—Ç–∏–Ω–∫–∏</div>
        <button class="btn-neu" onclick="generateImageOutput()">üñº –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ "–î–≤—ñ –∫–æ–ª–æ–Ω–∫–∏"</button>
        <img id="generatedImage" src="">
        <button class="btn-neu" id="btnSaveImg" onclick="saveImageToGallery()" style="display: none; color: #007aff; margin-top: 10px;">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É</button>
    </div>
</div>

<div id="captureTarget"></div>

<script>
    const finalTextDiv = document.getElementById('finalText');
    const copyBlock = document.getElementById('copyBlock');
    const copyHint = document.getElementById('copyHint');
    const editorWrapper = document.getElementById('editorWrapper');
    const editorChips = document.getElementById('editorChips');
    const emergencyBlock = document.getElementById('emergencyBlock');
    const btnEmToggle = document.getElementById('btnEmToggle');
    const btnPush = document.getElementById('btnPush');

    let lastDateStr = "–°–¨–û–ì–û–î–ù–Ü";
    let lastTextIntervals = "";
    let globalIntervals = [];
    let isEmergencyActive = false;

    // === –•–ï–õ–ü–ï–†–ò ===
    function timeToMinutes(timeStr) {
        const [h, m] = timeStr.replace(/[^\d:]/g, '').split(':').map(Number);
        return (h || 0) * 60 + (m || 0);
    }
    function minutesToTime(mins) {
        const h = Math.floor(mins / 60); const m = mins % 60;
        return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
    }
    function getClockEmoji(timeStr) {
        let [h, m] = timeStr.split(':').map(Number); if (isNaN(m)) m = 0;
        let emojiTimeH = h % 12 || 12; 
        const fullClocks = ['üïõ','üïê','üïë','üïí','üïì','üïî','üïï','üïñ','üïó','üïò','üïô','üïö'];
        const halfClocks = ['üïß','üïú','üïù','üïû','üïü','üï†','üï°','üï¢','üï£','üï§','üï•','üï¶'];
        return (m >= 30) ? halfClocks[emojiTimeH === 12 ? 0 : emojiTimeH] : fullClocks[emojiTimeH === 12 ? 0 : emojiTimeH];
    }

    // === –ü–ê–†–°–ò–ù–ì ===
    function processData() {
        const text = document.getElementById('rawText').value;
        const dateRegex = /(\d{1,2})\s+(—Å—ñ—á–Ω—è|–ª—é—Ç–æ–≥–æ|–±–µ—Ä–µ–∑–Ω—è|–∫–≤—ñ—Ç–Ω—è|—Ç—Ä–∞–≤–Ω—è|—á–µ—Ä–≤–Ω—è|–ª–∏–ø–Ω—è|—Å–µ—Ä–ø–Ω—è|–≤–µ—Ä–µ—Å–Ω—è|–∂–æ–≤—Ç–Ω—è|–ª–∏—Å—Ç–æ–ø–∞–¥–∞|–≥—Ä—É–¥–Ω—è)/i;
        const dateMatch = text.match(dateRegex);
        if(dateMatch) lastDateStr = dateMatch[0].toUpperCase();

        const regex = /(?:^|\n)\s*1\.2\s+([^\n]+)/;
        const match = text.match(regex);
        if (!match) { alert("–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ —á–µ—Ä–≥—É 1.2!"); return; }

        const ranges = match[1].trim().split(';');
        let tempOutages = [];
        ranges.forEach(range => {
            let parts = range.split(/[\-\‚Äì\‚Äî]/); 
            if (parts.length < 2) return;
            let startStr = parts[0].trim(); let endStr = parts[1].trim();
            let startMin = timeToMinutes(startStr); let endMin = timeToMinutes(endStr);
            if (endMin === 0 || endStr === "24:00") endMin = 1440; 
            if (endMin < startMin) endMin = 1440; 
            tempOutages.push({ startMin, endMin, startStr, displayEndStr: (endStr === "24:00" || endMin === 1440 ? "00:00" : endStr) });
        });
        tempOutages.sort((a, b) => a.startMin - b.startMin);

        globalIntervals = [];
        let currentTime = 0;
        tempOutages.forEach(outage => {
            if (currentTime < outage.startMin) {
                globalIntervals.push({ type: 'on', isModified: false, startMin: currentTime, endMin: outage.startMin, startStr: minutesToTime(currentTime), displayEndStr: minutesToTime(outage.startMin) });
            }
            globalIntervals.push({ type: 'off', isModified: false, startMin: outage.startMin, endMin: outage.endMin, displayEndStr: outage.displayEndStr, startStr: outage.startStr });
            currentTime = outage.endMin;
        });
        if (currentTime < 1440) {
            globalIntervals.push({ type: 'on', isModified: false, startMin: currentTime, endMin: 1440, startStr: minutesToTime(currentTime), displayEndStr: "00:00" });
        }

        updateUI();
        emergencyBlock.style.display = 'block';
        document.getElementById('imageGenBlock').style.display = 'block';
        btnPush.style.display = 'flex';
    }

    function updateUI() {
        renderEditorChips();
        let textIntervals = [];
        globalIntervals.forEach(int => {
            let isActuallyOff = (int.type === 'off' && !int.isModified) || (int.type === 'on' && int.isModified);
            if (isActuallyOff) {
                let note = (int.type === 'on' && int.isModified) ? " (–∞–≤–∞—Ä—ñ–π–Ω–µ ‚ö†Ô∏è)" : "";
                textIntervals.push(`${getClockEmoji(int.startStr)} ${int.startStr}-${int.displayEndStr}${note}`);
            }
        });
        lastTextIntervals = textIntervals.join('\n');
        
        finalTextDiv.textContent = `**–ì–†–ê–§–Ü–ö –í–Ü–î–ö–õ–Æ–ß–ï–ù–¨ [${lastDateStr}]**\n\n${lastTextIntervals}\n\n‚ö°Ô∏è –í—ñ–¥–∫—Ä–∏—Ç–∏ —ñ–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏–π –≥—Ä–∞—Ñ—ñ–∫: https://t.me/valkyelectrifybot/grafik\n\nüí¨ –ß–∞—Ç: t.me/valkychat\nüì£ –ë–∞–∑–∞—Ä—á–∏–∫: t.me/valkybazar`;
        copyBlock.style.display = 'block';
        copyBlock.classList.remove('copied'); copyHint.textContent = "–¢–∞–ø–Ω–∏, —â–æ–± —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ —Ç–µ–∫—Å—Ç";
    }

    function renderEditorChips() {
        editorChips.innerHTML = '';
        if (globalIntervals.length > 0) {
            editorWrapper.style.display = 'block';
            globalIntervals.forEach((int) => {
                const btn = document.createElement('div');
                let timeText = `${int.startStr} - ${int.displayEndStr}`;
                if (int.type === 'off') {
                    btn.className = `edit-chip ${int.isModified ? 'rescued' : 'off-state'}`;
                    btn.innerHTML = `üåë ${timeText} ${int.isModified ? 'üí°' : ''}`;
                } else {
                    btn.className = `edit-chip ${int.isModified ? 'emergency' : 'on-state'}`;
                    btn.innerHTML = `üí° ${timeText} ${int.isModified ? '‚ö†Ô∏è' : ''}`;
                }
                btn.onclick = () => { int.isModified = !int.isModified; updateUI(); };
                editorChips.appendChild(btn);
            });
        } else { editorWrapper.style.display = 'none'; }
    }

    function toggleEmergency() {
        isEmergencyActive = !isEmergencyActive;
        if(isEmergencyActive) {
            emergencyBlock.classList.add('active');
            btnEmToggle.textContent = "‚úÖ –í–∏–º–∫–Ω—É—Ç–∏ –∞–≤–∞—Ä—ñ—é";
            btnEmToggle.style.color = "#333";
        } else {
            emergencyBlock.classList.remove('active');
            btnEmToggle.textContent = "–£–≤—ñ–º–∫–Ω—É—Ç–∏ –∞–≤–∞—Ä—ñ—é";
            btnEmToggle.style.color = "var(--c-red)";
            document.getElementById('emStart').value = "";
            document.getElementById('emEnd').value = "";
        }
    }

    // === –ü–£–® –£ MINI APP ===
    async function pushToMiniApp() {
        const BIN_ID = '699b325fd0ea881f40cf7aaf'; 
        const API_KEY = '$2a$10$LtEcs8xMXZsRCDbVKHwou..M4xtkpoEM/3CJuf76Q0gK3gZ0I607C'; 
        
        if (globalIntervals.length === 0) { alert("–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏!"); return; }

        const btnOrigText = btnPush.textContent;
        btnPush.textContent = "‚è≥ –í—ñ–¥–ø—Ä–∞–≤–∫–∞...";

        const dataToSave = {
            date: lastDateStr,
            intervals: globalIntervals,
            emergency: {
                active: isEmergencyActive,
                start: document.getElementById('emStart').value.trim() || "",
                end: document.getElementById('emEnd').value.trim() || ""
            },
            updatedAt: new Date().toISOString()
        };

        try {
            const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
                body: JSON.stringify(dataToSave)
            });

            if (response.ok) { alert("‚úÖ –ì—Ä–∞—Ñ—ñ–∫ —É—Å–ø—ñ—à–Ω–æ –∑–∞–ª–µ—Ç—ñ–≤ —É Mini App!"); } 
            else { alert("‚ùå –ü–æ–º–∏–ª–∫–∞: " + response.statusText); }
        } catch (error) {
            alert("‚ùå –°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–ø—Ä–∞–≤—Ü—ñ."); console.error(error);
        } finally {
            btnPush.textContent = btnOrigText;
        }
    }

    function copyToClipboard() {
        navigator.clipboard.writeText(finalTextDiv.textContent).then(() => {
            copyBlock.classList.add('copied'); copyHint.textContent = "–°–ö–û–ü–Ü–ô–û–í–ê–ù–û! ‚úÖ"; copyHint.style.color = "#28a745";
        });
    }

    function clearAll() {
        document.getElementById('rawText').value = '';
        globalIntervals = []; isEmergencyActive = false;
        editorWrapper.style.display = 'none'; copyBlock.style.display = 'none'; emergencyBlock.style.display = 'none'; document.getElementById('imageGenBlock').style.display = 'none'; btnPush.style.display = 'none';
        emergencyBlock.classList.remove('active'); btnEmToggle.textContent = "–£–≤—ñ–º–∫–Ω—É—Ç–∏ –∞–≤–∞—Ä—ñ—é"; btnEmToggle.style.color = "var(--c-red)";
    }

    /* –ó–ê–ì–õ–£–®–ö–ê –î–õ–Ø –ì–ï–ù–ï–†–ê–¶–Ü–á –ö–ê–†–¢–ò–ù–ö–ò (—è–∫—â–æ –∫–æ–ª–∏—Å—å –∑–Ω–∞–¥–æ–±–∏—Ç—å—Å—è) */
    function generateImageOutput() { alert("–©–æ–± —Ü–µ –∑–∞–ø—Ä–∞—Ü—é–≤–∞–ª–æ, —Ç—Ä–µ–±–∞ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ CSS —ñ HTML –¥–ª—è —Ä–µ–Ω–¥–µ—Ä—É. –ó–∞—Ä–∞–∑ –∫–æ–¥ –æ—á–∏—â–µ–Ω–æ –¥–ª—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ."); }
</script>
</body>
</html>
