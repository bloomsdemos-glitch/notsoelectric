<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ELECTRIFY (c)</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-app: #e0e5ec; --text-main: #4a4a4a; --radius: 20px;
            --neumorph-shadow-light: #ffffff; --neumorph-shadow-dark: #a3b1c6;
            --c-yellow: #fbbf24; --c-red: #d9463b; --c-dark: #060606;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg-app); color: var(--text-main); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .app-container { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 20px; }

        .card { background: var(--bg-app); padding: 25px; border-radius: var(--radius); box-shadow: 9px 9px 16px var(--neumorph-shadow-dark), -9px -9px 16px var(--neumorph-shadow-light); border: 1px solid rgba(255,255,255,0.2); }
        h2 { margin: 0 0 20px 0; font-weight: 900; color: #333; letter-spacing: -0.5px; }

        .form-group { margin-bottom: 15px; }
        .form-label { font-size: 12px; font-weight: bold; color: #666; margin-left: 5px; display: block; margin-bottom: 5px; }
        
        .input-neumorph { width: 100%; border: none; border-radius: 12px; padding: 15px; font-family: inherit; background: var(--bg-app); box-shadow: inset 6px 6px 10px var(--neumorph-shadow-dark), inset -6px -6px 10px var(--neumorph-shadow-light); box-sizing: border-box; color: #333; outline: none; transition: 0.3s; font-weight: 500; }
        .input-neumorph:focus { box-shadow: inset 4px 4px 8px var(--neumorph-shadow-dark), inset -4px -4px 8px var(--neumorph-shadow-light); }
        textarea.input-neumorph { height: 100px; resize: none; font-family: monospace; font-weight: normal; }
        select.input-neumorph { appearance: none; background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23333%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 15px top 50%; background-size: 12px auto; cursor: pointer; }

        .btn-group { display: flex; gap: 15px; margin-top: 20px; }
        .btn-neu { flex: 1; padding: 16px; border: none; border-radius: 12px; font-weight: 700; font-size: 15px; cursor: pointer; background: var(--bg-app); box-shadow: 6px 6px 10px var(--neumorph-shadow-dark), -6px -6px 10px var(--neumorph-shadow-light); color: #333; transition: all 0.2s ease; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-neu:active { box-shadow: inset 4px 4px 8px var(--neumorph-shadow-dark), inset -4px -4px 8px var(--neumorph-shadow-light); transform: scale(0.98); }
        .btn-primary { color: #007aff; } .btn-danger { color: #ff3b30; }
        .tools-row { display: flex; gap: 10px; margin-bottom: 15px; }

        /* –ï–î–ò–¢–û–† –Ü–ù–¢–ï–†–í–ê–õ–Ü–í */
        #editorWrapper { display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(0,0,0,0.05); }
        .edit-chips-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .edit-chip { padding: 8px 14px; border-radius: 10px; font-size: 13px; font-weight: 700; cursor: pointer; background: var(--bg-app); border: 2px solid var(--c-red); color: var(--c-red); transition: 0.2s; user-select: none; box-shadow: 3px 3px 6px var(--neumorph-shadow-dark), -3px -3px 6px var(--neumorph-shadow-light); }
        .edit-chip:active { transform: scale(0.95); }
        .edit-chip.rescued { border-color: var(--c-yellow); background: var(--c-yellow); color: #000; box-shadow: none; }

        #outputWrapper { display: none; width: 100%; }
        #generatedImage { width: 100%; height: auto; display: block; margin-bottom: 15px; box-shadow: 5px 5px 15px rgba(0,0,0,0.15); border-radius: 0; }
        
        .copy-block { margin-top: 15px; padding: 20px; border-radius: 15px; background: var(--bg-app); cursor: pointer; transition: all 0.2s; position: relative; user-select: none; box-shadow: 7px 7px 14px var(--neumorph-shadow-dark), -7px -7px 14px var(--neumorph-shadow-light); }
        .copy-block:active { box-shadow: inset 5px 5px 10px var(--neumorph-shadow-dark), inset -5px -5px 10px var(--neumorph-shadow-light); transform: scale(0.99); }
        .copy-block.copied { background: #e3fae3; }
        .copy-content { font-family: monospace; font-size: 14px; color: #333; white-space: pre-wrap; line-height: 1.4; pointer-events: none; }
        .copy-hint { margin-top: 10px; font-size: 12px; color: #007aff; text-align: center; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

        /* === –ë–ê–ó–û–í–ò–ô –¢–ï–ú–ù–ò–ô –®–ê–ë–õ–û–ù === */
        #captureTarget { background: var(--c-dark); color: #ffffff; padding: 40px; position: absolute; left: -9999px; top: 0; width: 440px; box-sizing: border-box; -webkit-font-smoothing: antialiased; overflow: hidden; border-radius: 0; }
        .header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 35px; position: relative; z-index: 2; }
        .header-title { font-size: 24px; font-weight: 900; line-height: 1.25; letter-spacing: 0.5px; text-transform: uppercase; }
        .header-title span { color: var(--c-yellow); }
        .logo-fixed { width: 48px; height: 48px; object-fit: contain; border-radius: 50%; background: #ffffff; padding: 4px; box-sizing: border-box; }

        .footer-info { margin-top: 25px; padding-top: 20px; border-top: 1px solid #1f1f22; display: flex; flex-direction: column; gap: 10px; position: relative; z-index: 2; }
        .disclaimer-box { display: flex; align-items: flex-start; gap: 8px; font-size: 12px; color: #6b7280; line-height: 1.4; font-weight: 500; }
        .disclaimer-icon { width: 16px; height: 16px; flex-shrink: 0; color: #6b7280; margin-top: 1px; }
        .footer-source { font-size: 12px; font-weight: 600; color: #888; display: flex; justify-content: space-between; align-items: center; }

        /* === –¢–ï–ú–ê 1: –°–ú–ê–†–¢-–î–Ü–ú (–¢–ê–ô–ú–õ–ê–ô–ù) === */
        .tl-item { display: flex; position: relative; margin-bottom: 0; min-height: 75px; z-index: 2; }
        .tl-item:last-child .tl-line, .tl-item:last-child .tl-dot { display: none; } 
        .tl-item:last-child .content-col { padding-bottom: 0; }
        
        .time-col { width: 65px; text-align: right; padding-right: 15px; font-weight: 700; font-size: 18px; padding-top: 2px; }
        .time-col.off { color: var(--c-red); }
        .time-col.on { color: var(--c-yellow); text-shadow: 0 0 10px rgba(251, 191, 36, 0.4); }
        
        .line-col { display: flex; flex-direction: column; align-items: center; width: 24px; position: relative; z-index: 2; }
        .icon-circle { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: var(--c-dark); z-index: 3; }
        .icon-house { width: 12px; height: 12px; }
        .on .icon-house { fill: var(--c-yellow); filter: drop-shadow(0 0 5px var(--c-yellow)); }
        .off .icon-house { fill: #555; }
        
        .tl-line { flex-grow: 1; margin-top: 4px; margin-bottom: 4px; min-height: 35px; width: 2px; }
        .tl-line.dotted { background-image: linear-gradient(to bottom, #444 50%, transparent 50%); background-size: 2px 10px; }
        .tl-line.solid { background: var(--c-yellow); box-shadow: 0 0 8px var(--c-yellow); }
        .tl-dot { width: 6px; height: 6px; border-radius: 50%; margin-bottom: 4px; z-index: 3; }
        .tl-dot.dot-on { background: var(--c-yellow); box-shadow: 0 0 5px var(--c-yellow); }
        .tl-dot.dot-off { background: #555; }

        .content-col { padding-left: 15px; flex-grow: 1; padding-bottom: 25px; display: flex; flex-direction: column; justify-content: flex-start; }
        .info-row { display: flex; align-items: center; gap: 12px; } 
        
        .badge { display: flex; align-items: center; justify-content: center; padding: 4px 12px; border-radius: 8px; font-size: 13px; font-weight: 800; letter-spacing: 0.5px; height: 26px; box-sizing: border-box; }
        .badge.off { background: #1a1a1c; border: 1px solid #333; color: #a1a1aa; }
        .badge.on { background: var(--c-yellow); color: #000; box-shadow: 0 0 15px rgba(251, 191, 36, 0.3); border: 1px solid var(--c-yellow); }
        
        .interval { display: flex; align-items: center; gap: 6px; font-size: 16px; font-weight: 600; }
        .interval-icon { width: 16px; height: 16px; display: flex; align-items: center; }
        .interval.off { color: var(--c-red); }
        .interval.on { color: var(--c-yellow); }

        /* === –¢–ï–ú–ê 2: –î–í–Ü –ö–û–õ–û–ù–ö–ò === */
        .tc-location { display: flex; align-items: center; gap: 6px; font-size: 16px; color: #888; font-weight: 600; margin-top: 8px; text-transform: none; letter-spacing: 0; }
        .tc-location-icon { width: 16px; height: 16px; fill: currentColor; }
        .tc-wrapper { display: flex; gap: 20px; text-align: center; margin-bottom: 10px; position: relative; z-index: 2; }
        .tc-col { flex: 1; display: flex; flex-direction: column; align-items: center; }
        
        .tc-badge { padding: 8px 16px; border-radius: 12px; font-size: 14px; font-weight: 800; letter-spacing: 0.5px; margin-bottom: 20px; display: inline-block; width: 100%; box-sizing: border-box; }
        .tc-badge.off { background: var(--c-red); color: #fff; box-shadow: 0 0 15px rgba(217, 70, 59, 0.3); }
        .tc-badge.on { background: var(--c-yellow); color: #000; box-shadow: 0 0 15px rgba(251, 191, 36, 0.3); }
        
        .tc-times-wrapper { display: flex; flex-direction: column; gap: 12px; width: 100%; position: relative; padding-bottom: 20px; }
        .tc-bracket-line { position: absolute; width: 2px; background: #333; top: -10px; bottom: 0; left: 50%; transform: translateX(-50%); z-index: 1; }
        .tc-bracket-bottom { position: absolute; height: 2px; background: #333; bottom: 0; left: 20%; right: 20%; z-index: 1; }
        .tc-bracket-tick { position: absolute; width: 2px; height: 10px; background: #333; bottom: -10px; left: 50%; transform: translateX(-50%); z-index: 1; }
        
        .tc-time { font-size: 20px; font-weight: 700; letter-spacing: 1px; position: relative; z-index: 2; background: var(--c-dark); padding: 4px 0; }
        .tc-time.off { color: #fff; }
        .tc-time.on { color: #fff; }
        
        .tc-total { font-size: 14px; font-weight: 700; margin-top: 15px; color: #a1a1aa; background: var(--c-dark); padding: 0 10px; position: relative; z-index: 2; }
        .tc-lightning { position: absolute; left: 50%; top: 5px; transform: translateX(-50%); color: var(--c-yellow); width: 24px; height: 24px; }

        /* === –¢–ï–ú–ê 3: –ï–ú–û–î–ó–Ü –°–ü–õ–ï–® === */
        .emoji-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
        .emoji-content-wrapper { position: relative; z-index: 2; display: flex; flex-direction: column; align-items: center; text-align: center; padding: 10px 0 20px 0; }
        .em-time { font-size: 36px; font-weight: 800; color: var(--c-red); margin-bottom: 20px; letter-spacing: 2px; display: flex; align-items: center; justify-content: center; gap: 12px; width: 100%; }
        .em-time:last-child { margin-bottom: 0; }
        .em-arrow { width: 24px; height: 24px; color: #555; }

    </style>
</head>
<body>

    <div class="app-container">
        <div class="card">
            <h2>ELECTRIFY &copy;</h2>
            
            <div class="form-group">
                <label class="form-label">–í—ñ–∑—É–∞–ª—å–Ω–∏–π –¥–∏–∑–∞–π–Ω (–º–æ–∂–Ω–∞ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –Ω–∞ –ª—å–æ—Ç—É):</label>
                <select id="designSelect" class="input-neumorph" onchange="if(currentOutages.length) processDataAndGenerate(false)">
                    <option value="timeline">üè† –°–º–∞—Ä—Ç-–¥—ñ–º (–¢–∞–π–º–ª–∞–π–Ω)</option>
                    <option value="columns">‚öñÔ∏è –î–≤—ñ –∫–æ–ª–æ–Ω–∫–∏ (–Ñ / –ù–µ–º–∞—î)</option>
                    <option value="emojis">üéà –ú—ñ–Ω—ñ–º–∞–ª—ñ–∑–º (–†–∞–Ω–¥–æ–º–Ω—ñ –µ–º–æ–¥–∑—ñ)</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ—Å—Ç—É:</label>
                <input type="text" id="postTitleInput" class="input-neumorph" value="–ì–†–ê–§–Ü–ö –í–Ü–î–ö–õ–Æ–ß–ï–ù–¨ –ù–ê [–î–ê–¢–ê]" placeholder="–í–≤–µ–¥–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ (—Ç–µ–≥ [–î–ê–¢–ê] –∑–∞–º—ñ–Ω–∏—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ)">
            </div>

            <textarea id="rawText" class="input-neumorph" placeholder="–í—Å—Ç–∞–≤ —Ç–µ–∫—Å—Ç –≥—Ä–∞—Ñ—ñ–∫—É –≤—ñ–¥ –•–∞—Ä–∫—ñ–≤–æ–±–ª–µ–Ω–µ—Ä–≥–æ —Å—é–¥–∏ (–∑ —á–µ—Ä–≥–æ—é 1.2)..."></textarea>
            
            <div class="btn-group">
                <button class="btn-neu btn-primary" onclick="processDataAndGenerate(true)">‚ö° –°—Ç–≤–æ—Ä–∏—Ç–∏</button>
                <button class="btn-neu btn-danger" onclick="clearAll()">‚ùå</button>
            </div>

            <div id="editorWrapper">
                <label class="form-label">–°–í–Ü–¢–õ–û –ë–£–õ–û? (–Ω–∞—Ç–∏—Å–Ω–∏ –Ω–∞ –±–ª–æ–∫, —â–æ–± —Å–∫–∞—Å—É–≤–∞—Ç–∏ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è):</label>
                <div class="edit-chips-container" id="editorChips"></div>
            </div>

            <div id="debug" style="color:red; font-size:12px; margin-top:10px; text-align:center;"></div>
        </div>

        <div id="outputWrapper">
            <div class="tools-row">
                <button class="btn-neu" onclick="saveImageToGallery()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
            </div>
            <img id="generatedImage" src="">
            <div class="copy-block" id="copyBlock" onclick="copyToClipboard()">
                <div class="copy-content" id="finalText">–¢—É—Ç –±—É–¥–µ —Ç–µ–∫—Å—Ç...</div>
                <div class="copy-hint" id="copyHint">–¢–∞–ø–Ω–∏, —â–æ–± —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ —Ç–µ–∫—Å—Ç</div>
            </div>
        </div>
    </div>

    <div id="captureTarget"></div>

    <script>
        // === –Ü–ö–û–ù–ö–ò ===
        const houseSvg = `<svg class="icon-house" viewBox="0 0 24 24"><path d="M12 3L2 12h3v8h14v-8h3L12 3z"/></svg>`;
        const iconBulb = `<svg class="interval-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1.2 1.5-2.5 1.5-4a6 6 0 0 0-6-6 6 6 0 0 0-6 6c0 1.4.5 2.7 1.5 4 .7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>`;
        const iconZapOff = `<svg class="interval-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="2" y1="2" x2="22" y2="22"></line><path d="M8.5 8.5L3 14h9l-1 8 5.5-5.5"></path><path d="M16 10h5l-1.5 1.5"></path><path d="M12.4 6.6L13 2l-2.6 2.6"></path></svg>`;
        const iconInfo = `<svg class="disclaimer-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>`;
        const iconPin = `<svg class="tc-location-icon" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>`;
        const iconLightning = `<svg class="tc-lightning" viewBox="0 0 24 24" fill="currentColor"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>`;
        const iconArrow = `<svg class="em-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>`;

        // === DOM ===
        const debug = document.getElementById('debug');
        const finalTextDiv = document.getElementById('finalText');
        const copyBlock = document.getElementById('copyBlock');
        const copyHint = document.getElementById('copyHint');
        const captureTarget = document.getElementById('captureTarget');
        const outputWrapper = document.getElementById('outputWrapper');
        const generatedImage = document.getElementById('generatedImage');
        const designSelect = document.getElementById('designSelect');
        const postTitleInput = document.getElementById('postTitleInput');
        
        const editorWrapper = document.getElementById('editorWrapper');
        const editorChips = document.getElementById('editorChips');

        let lastDateStr = "";
        let lastTextIntervals = "";
        let currentOutages = []; // –ì–ª–æ–±–∞–ª—å–Ω–∏–π –º–∞—Å–∏–≤ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å (–∑—ñ —Å—Ç–∞—Ç—É—Å–æ–º rescued)

        // === –•–ï–õ–ü–ï–†–ò ===
        function timeToMinutes(timeStr) {
            const [h, m] = timeStr.replace(/[^\d:]/g, '').split(':').map(Number);
            return (h || 0) * 60 + (m || 0);
        }

        function minutesToTime(mins) {
            const h = Math.floor(mins / 60);
            const m = mins % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        function getHeaderTitle(dateStr) {
            let rawTitle = postTitleInput.value.trim() || "–ì–†–ê–§–Ü–ö –í–Ü–î–ö–õ–Æ–ß–ï–ù–¨ –ù–ê [–î–ê–¢–ê]";
            return rawTitle.replace(/\[–î–ê–¢–ê\]/gi, dateStr);
        }

        function getClockEmoji(timeStr) {
            let [h, m] = timeStr.split(':').map(Number);
            if (isNaN(m)) m = 0;
            let emojiTimeH = h % 12 || 12; 
            const fullClocks = ['üïõ','üïê','üïë','üïí','üïì','üïî','üïï','üïñ','üïó','üïò','üïô','üïö'];
            const halfClocks = ['üïß','üïú','üïù','üïû','üïü','üï†','üï°','üï¢','üï£','üï§','üï•','üï¶'];
            return (m >= 30) ? halfClocks[emojiTimeH === 12 ? 0 : emojiTimeH] : fullClocks[emojiTimeH === 12 ? 0 : emojiTimeH];
        }

        // === –ì–û–õ–û–í–ù–ò–ô –ü–†–û–¶–ï–° (–ó –ü–Ü–î–¢–†–ò–ú–ö–û–Æ –†–ï–î–ê–ì–£–í–ê–ù–ù–Ø) ===
        // fromRawText = true, —è–∫—â–æ –º–∏ —Ç–∏—Å–Ω–µ–º–æ "–°—Ç–≤–æ—Ä–∏—Ç–∏" (—Ç—Ä–µ–±–∞ –ø–∞—Ä—Å–∏—Ç–∏ —Ç–µ–∫—Å—Ç)
        // fromRawText = false, —è–∫—â–æ –º–∏ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–º–∏–∫–∞—î–º–æ –¥–∏–∑–∞–π–Ω –∞–±–æ –∫–ª—ñ–∫–∞—î–º–æ –Ω–∞ —á—ñ–ø (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —ñ—Å–Ω—É—é—á–∏–π currentOutages)
        function processDataAndGenerate(fromRawText = true) {
            debug.textContent = "";
            
            if (fromRawText) {
                const text = document.getElementById('rawText').value;
                const dateRegex = /(\d{1,2})\s+(—Å—ñ—á–Ω—è|–ª—é—Ç–æ–≥–æ|–±–µ—Ä–µ–∑–Ω—è|–∫–≤—ñ—Ç–Ω—è|—Ç—Ä–∞–≤–Ω—è|—á–µ—Ä–≤–Ω—è|–ª–∏–ø–Ω—è|—Å–µ—Ä–ø–Ω—è|–≤–µ—Ä–µ—Å–Ω—è|–∂–æ–≤—Ç–Ω—è|–ª–∏—Å—Ç–æ–ø–∞–¥–∞|–≥—Ä—É–¥–Ω—è)/i;
                const dateMatch = text.match(dateRegex);
                lastDateStr = dateMatch ? dateMatch[0].toUpperCase() : "–°–¨–û–ì–û–î–ù–Ü";

                const regex = /(?:^|\n)\s*1\.2\s+([^\n]+)/;
                const match = text.match(regex);
                if (!match) { debug.textContent = "–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ —á–µ—Ä–≥—É 1.2!"; return; }

                const ranges = match[1].trim().split(';');
                currentOutages = [];

                ranges.forEach(range => {
                    let parts = range.split(/[\-\‚Äì\‚Äî]/); 
                    if (parts.length < 2) return;
                    
                    let startStr = parts[0].trim(); 
                    let endStr = parts[1].trim();

                    let startMin = timeToMinutes(startStr);
                    let endMin = timeToMinutes(endStr);
                    
                    if (endMin === 0 || endStr === "24:00") endMin = 1440; 
                    if (endMin < startMin) endMin = 1440; 

                    currentOutages.push({ 
                        startMin, 
                        endMin, 
                        startStr, 
                        displayEndStr: (endStr === "24:00" || endMin === 1440 ? "00:00" : endStr),
                        isRescued: false // –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –∂–æ–¥–Ω–µ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –Ω–µ —Å–∫–∞—Å–æ–≤–∞–Ω–µ
                    });
                });

                currentOutages.sort((a, b) => a.startMin - b.startMin);
            }

            // –†–µ–Ω–¥–µ—Ä–∏–º–æ —á—ñ–ø–∏ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
            renderEditorChips();

            let totalOffMinutes = 0;
            let textIntervals = [];

            // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Ç–µ–∫—Å—Ç—É —ñ –≥–æ–¥–∏–Ω (–≤—Ä–∞—Ö–æ–≤—É—é—á–∏ isRescued)
            currentOutages.forEach(outage => {
                if (!outage.isRescued) {
                    totalOffMinutes += (outage.endMin - outage.startMin);
                }
                
                let displayStartText = outage.startStr === "24:00" ? "00:00" : outage.startStr;
                let displayEndText = outage.displayEndStr;
                // –î–æ–¥–∞—î–º–æ –µ–º–æ–¥–∑—ñ-–ø—Ä–∏–ø–∏—Å–∫—É, —è–∫—â–æ —Å–≤—ñ—Ç–ª–æ –±—É–ª–æ
                let note = outage.isRescued ? " (—Å–≤—ñ—Ç–ª–æ –±—É–ª–æ üí°)" : "";
                
                textIntervals.push(`${getClockEmoji(outage.startStr)} ${displayStartText}-${displayEndText}${note}`);
            });

            lastTextIntervals = textIntervals.join('\n');

            let allIntervals = [];
            let currentTime = 0;
            
            // –ë—É–¥—É—î–º–æ —É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π –º–∞—Å–∏–≤ –¥–ª—è –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—ó
            currentOutages.forEach(outage => {
                if (currentTime < outage.startMin) {
                    allIntervals.push({ isOn: true, isRescued: false, startMin: currentTime, endMin: outage.startMin });
                }
                
                // –Ø–∫—â–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Å–∫–∞—Å–æ–≤–∞–Ω–µ (isRescued = true), –≤–æ–Ω–æ —Ç—Ä–∞–∫—Ç—É—î—Ç—å—Å—è —è–∫ –°–í–Ü–¢–õ–û –Ñ (isOn: true)
                allIntervals.push({ 
                    isOn: outage.isRescued ? true : false, 
                    isRescued: outage.isRescued, 
                    startMin: outage.startMin, 
                    endMin: outage.endMin, 
                    displayEndStr: outage.displayEndStr,
                    startStr: outage.startStr
                });
                
                currentTime = outage.endMin;
            });

            if (currentTime < 1440) {
                allIntervals.push({ isOn: true, isRescued: false, startMin: currentTime, endMin: 1440 });
            }

            const totalHoursOff = (totalOffMinutes / 60).toFixed(1).replace('.0', '');
            const totalHoursOn = (24 - totalOffMinutes / 60).toFixed(1).replace('.0', '');

            const design = designSelect.value;
            const finalTitle = getHeaderTitle(lastDateStr).replace(lastDateStr, `<span>${lastDateStr}</span>`);

            if (design === 'timeline') renderTimeline(allIntervals, totalHoursOff, finalTitle);
            else if (design === 'columns') renderColumns(allIntervals, totalHoursOff, totalHoursOn, finalTitle);
            else if (design === 'emojis') renderEmojis(currentOutages, finalTitle); // –î–ª—è –µ–º–æ–¥–∑—ñ –ø–µ—Ä–µ–¥–∞—î–º–æ —á–∏—Å—Ç–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è

            updateCopyText();
            outputWrapper.style.display = 'block';
            setTimeout(generateImageOutput, 300);
        }

        // –†–µ–Ω–¥–µ—Ä –∫–Ω–æ–ø–æ–∫ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è (–ß—ñ–ø–∏)
        function renderEditorChips() {
            editorChips.innerHTML = '';
            if (currentOutages.length > 0) {
                editorWrapper.style.display = 'block';
                currentOutages.forEach((outage, index) => {
                    const btn = document.createElement('div');
                    btn.className = `edit-chip ${outage.isRescued ? 'rescued' : ''}`;
                    btn.innerHTML = `${outage.startStr} - ${outage.displayEndStr} ${outage.isRescued ? '‚úÖ –ë–£–õ–û' : ''}`;
                    
                    btn.onclick = () => {
                        outage.isRescued = !outage.isRescued;
                        processDataAndGenerate(false); // –†–µ–≥–µ–Ω–µ—Ä—É—î–º–æ –ë–ï–ó –ø–∞—Ä—Å–∏–Ω–≥—É —Ç–µ–∫—Å—Ç—É
                    };
                    editorChips.appendChild(btn);
                });
            } else {
                editorWrapper.style.display = 'none';
            }
        }

        // === –°–¢–ê–ù–î–ê–†–¢–ù–ò–ô –§–£–¢–ï–† ===
        function getStandardFooter(hoursOffHtml = "") {
            return `
                <div class="footer-info">
                    ${hoursOffHtml}
                    <div class="disclaimer-box">${iconInfo}<div>–ì—Ä–∞—Ñ—ñ–∫ —î –æ—Ä—ñ—î–Ω—Ç–æ–≤–Ω–∏–º, –æ—Å–∫—ñ–ª—å–∫–∏ —Å–∏—Ç—É–∞—Ü—ñ—è –≤ –µ–Ω–µ—Ä–≥–æ—Å–∏—Å—Ç–µ–º—ñ –ø–æ—Å—Ç—ñ–π–Ω–æ –∑–º—ñ–Ω—é—î—Ç—å—Å—è.</div></div>
                    <div class="footer-source">
                        <span>–î–∂–µ—Ä–µ–ª–æ: –•–∞—Ä–∫—ñ–≤–æ–±–ª–µ–Ω–µ—Ä–≥–æ</span>
                    </div>
                </div>`;
        }

        // === –†–ï–ù–î–ï–† –¢–ï–ú–ê 1: –°–ú–ê–†–¢ –î–Ü–ú ===
        function renderTimeline(intervals, totalHoursOff, finalTitle) {
            let html = `
                <div class="header-row">
                    <div class="header-title">${finalTitle}</div>
                    <img src="./logo.png" alt="" class="logo-fixed">
                </div>
                <div id="timelineContainer">`;
            
            intervals.forEach((int, i) => {
                const stateClass = int.isOn ? 'on' : 'off';
                // –Ø–∫—â–æ –º–∞–Ω—É–∞–ª—å–Ω–æ –≤—Ä—è—Ç–æ–≤–∞–Ω–µ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è ‚Äî –∑–º—ñ–Ω—é—î–º–æ –±–µ–π–¥–∂
                const badgeText = int.isRescued ? '–°–í–Ü–¢–õ–û –ë–£–õ–û' : (int.isOn ? '–°–í–Ü–¢–õ–û –Ñ' : '–í–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø');
                const lineClass = int.isOn ? 'solid' : 'dotted';
                const intIcon = int.isOn ? iconBulb : iconZapOff;
                const startStr = int.startStr || minutesToTime(int.startMin);
                const endStr = int.displayEndStr || (int.endMin === 1440 ? "00:00" : minutesToTime(int.endMin));
                
                let dotHtml = '';
                if (i < intervals.length - 1) {
                    const nextOn = intervals[i+1].isOn;
                    const dotClass = nextOn ? 'dot-on' : 'dot-off';
                    dotHtml = `<div class="tl-dot ${dotClass}"></div>`;
                }

                html += `
                <div class="tl-item ${stateClass}">
                    <div class="time-col ${stateClass}">${startStr}</div>
                    <div class="line-col">
                        <div class="icon-circle">${houseSvg}</div>
                        <div class="tl-line ${lineClass}"></div>
                        ${dotHtml}
                    </div>
                    <div class="content-col">
                        <div class="info-row">
                            <div class="badge ${stateClass}">${badgeText}</div>
                            <div class="interval ${stateClass}">${intIcon} <span>${startStr} - ${endStr}</span></div>
                        </div>
                    </div>
                </div>`;
            });

            const hoursHtml = `<div class="total-time" style="margin-bottom:5px;">–ó–∞–≥–∞–ª—å–Ω–∏–π —á–∞—Å –±–µ–∑ —Å–≤—ñ—Ç–ª–∞: ~${totalHoursOff} –≥–æ–¥–∏–Ω.</div>`;
            html += `</div>` + getStandardFooter(hoursHtml);
            captureTarget.innerHTML = html;
        }

        // === –†–ï–ù–î–ï–† –¢–ï–ú–ê 2: –î–í–Ü –ö–û–õ–û–ù–ö–ò ===
        function renderColumns(intervals, totalHoursOff, totalHoursOn, finalTitle) {
            let offHtml = ''; let onHtml = '';
            
            intervals.forEach(int => {
                const startStr = int.startStr || minutesToTime(int.startMin);
                const endStr = int.displayEndStr || (int.endMin === 1440 ? "00:00" : minutesToTime(int.endMin));
                if (int.isOn) {
                    if (int.isRescued) {
                        // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ –≤ –∫–æ–ª–æ–Ω—Ü—ñ –Ñ –°–í–Ü–¢–õ–û, –∞–ª–µ –∑ –ø—Ä–∏–ø–∏—Å–∫–æ—é (–±—É–ª–æ)
                        onHtml += `<div class="tc-time on">${startStr} - ${endStr} <span style="font-size:14px; opacity:0.8;">(–±—É–ª–æ)</span></div>`;
                    } else {
                        onHtml += `<div class="tc-time on">${startStr} - ${endStr}</div>`;
                    }
                } else {
                    offHtml += `<div class="tc-time off">${startStr} - ${endStr}</div>`;
                }
            });

            captureTarget.innerHTML = `
                <div class="header-row" style="margin-bottom: 30px; justify-content: space-between; align-items: center;">
                    <div>
                        <div class="header-title">${finalTitle}</div>
                        <div class="tc-location">${iconPin} –í–∞–ª–∫–∏</div>
                    </div>
                    <img src="./logo.png" alt="" class="logo-fixed">
                </div>
                
                <div class="tc-wrapper">
                    ${iconLightning}
                    <div class="tc-col">
                        <div class="tc-badge off">–°–í–Ü–¢–õ–ê –ù–ï –ë–£–î–ï</div>
                        <div class="tc-times-wrapper">
                            <div class="tc-bracket-line"></div>
                            ${offHtml}
                            <div class="tc-bracket-bottom"></div>
                            <div class="tc-bracket-tick"></div>
                        </div>
                        <div class="tc-total">~${totalHoursOff} –≥–æ–¥–∏–Ω</div>
                    </div>

                    <div class="tc-col">
                        <div class="tc-badge on">–°–í–Ü–¢–õ–û –ë–£–î–ï</div>
                        <div class="tc-times-wrapper">
                            <div class="tc-bracket-line"></div>
                            ${onHtml}
                            <div class="tc-bracket-bottom"></div>
                            <div class="tc-bracket-tick"></div>
                        </div>
                        <div class="tc-total">~${totalHoursOn} –≥–æ–¥–∏–Ω</div>
                    </div>
                </div>
                ${getStandardFooter()}
                `;
        }

        // === –†–ï–ù–î–ï–† –¢–ï–ú–ê 3: –ï–ú–û–î–ó–Ü –°–ü–õ–ï–® ===
        function renderEmojis(outages, finalTitle) {
            const emList = ['‚ö°Ô∏è', 'üí°', 'üîå', 'üî¶', 'üîã'];
            let bgHtml = '<div class="emoji-bg">';
            
            // –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è —Ç—ñ–ª—å–∫–∏ –ø–æ –±–æ–∫–∞—Ö
            const generateSide = (minLeft, maxLeft) => {
                for(let i=0; i<6; i++) {
                    let em = emList[Math.floor(Math.random() * emList.length)];
                    let left = Math.floor(Math.random() * (maxLeft - minLeft)) + minLeft;
                    let top = 5 + (i * 15) + Math.random() * 10;
                    let size = Math.floor(Math.random() * 16) + 18;
                    let rot = Math.floor(Math.random() * 360);
                    let opac = (Math.floor(Math.random() * 5) + 3) / 10;
                    bgHtml += `<div style="position:absolute; left:${left}%; top:${top}%; font-size:${size}px; transform:rotate(${rot}deg); opacity:${opac};">${em}</div>`;
                }
            };
            
            generateSide(2, 18); // –õ—ñ–≤–∞ –∫–æ–ª–æ–Ω–∫–∞
            generateSide(82, 98); // –ü—Ä–∞–≤–∞ –∫–æ–ª–æ–Ω–∫–∞
            bgHtml += '</div>';

            let listHtml = '';
            outages.forEach(outage => {
                if (outage.isRescued) {
                    listHtml += `<div class="em-time" style="color:var(--c-yellow);">
                                    <span style="text-decoration:line-through; opacity:0.6;">${outage.startStr} ${iconArrow} ${outage.displayEndStr}</span> 
                                    <span style="font-size:20px; color:#fff;">(–±—É–ª–æ)</span>
                                 </div>`;
                } else {
                    listHtml += `<div class="em-time">${outage.startStr} ${iconArrow} ${outage.displayEndStr}</div>`;
                }
            });

            captureTarget.innerHTML = `
                ${bgHtml}
                <div class="header-row" style="margin-bottom: 20px; position:relative; z-index:2;">
                    <div>
                        <div class="header-title">${finalTitle}</div>
                        <div class="tc-location">${iconPin} –í–∞–ª–∫–∏</div>
                    </div>
                    <img src="./logo.png" alt="" class="logo-fixed">
                </div>
                
                <div class="emoji-content-wrapper">
                    ${listHtml}
                </div>
                ${getStandardFooter()}
                `;
        }

        // === –ü–õ–Æ–®–ö–ò ===
        function updateCopyText() {
            const header = getHeaderTitle(lastDateStr);
            finalTextDiv.textContent = `${header}\n\n${lastTextIntervals}\n\n–•–∞—Ä–∫—ñ–≤–æ–±–ª–µ–Ω–µ—Ä–≥–æ`;
            copyBlock.classList.remove('copied');
            copyHint.textContent = "–¢–∞–ø–Ω–∏, —â–æ–± —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ —Ç–µ–∫—Å—Ç";
            copyHint.style.color = "#007aff";
        }

        function generateImageOutput() {
            html2canvas(captureTarget, {
                scale: 3, backgroundColor: null, logging: false, useCORS: true
            }).then(canvas => {
                generatedImage.src = canvas.toDataURL('image/png');
            });
        }

        function copyToClipboard() {
            navigator.clipboard.writeText(finalTextDiv.textContent).then(() => {
                copyBlock.classList.add('copied');
                copyHint.textContent = "–°–ö–û–ü–Ü–ô–û–í–ê–ù–û! ‚úÖ";
                copyHint.style.color = "#28a745";
                if(navigator.vibrate) navigator.vibrate(50);
            }).catch(err => alert("–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ. –°–ø—Ä–æ–±—É–π –≤—Ä—É—á–Ω—É."));
        }

        async function saveImageToGallery() {
            if (!generatedImage.src) return;
            try {
                const response = await fetch(generatedImage.src);
                const blob = await response.blob();
                const file = new File([blob], "grafik_valky.png", { type: "image/png" });
                if (navigator.share) { await navigator.share({ files: [file] }); } 
                else { const link = document.createElement("a"); link.href = generatedImage.src; link.download = "grafik_valky.png"; document.body.appendChild(link); link.click(); document.body.removeChild(link); }
            } catch (err) { alert("–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è. –°–ø—Ä–æ–±—É–π –∑—Ä–æ–±–∏—Ç–∏ —Å–∫—Ä—ñ–Ω—à–æ—Ç."); }
        }

        function clearAll() {
            document.getElementById('rawText').value = '';
            captureTarget.innerHTML = '';
            currentOutages = [];
            editorWrapper.style.display = 'none';
            outputWrapper.style.display = 'none';
        }
    </script>
</body>
</html>
